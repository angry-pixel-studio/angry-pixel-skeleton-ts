(()=>{"use strict";const t={AssetManager:Symbol.for("AssetManager"),CanvasElement:Symbol.for("CanvasElement"),CollisionRepository:Symbol.for("CollisionRepository"),CollisionBroadphaseResolver:Symbol.for("CollisionBroadphaseResolver"),CollisionResolutionMethod:Symbol.for("CollisionResolutionMethod"),CollisionAABBResolver:Symbol.for("CollisionAABBResolver"),CollisionCircumferenceAABBResolver:Symbol.for("CollisionCircumferenceAABBResolver"),CollisionCircumferenceResolver:Symbol.for("CollisionCircumferenceResolver"),CollisionSatResolver:Symbol.for("CollisionSatResolver"),CollisionMatrix:Symbol.for("CollisionMatrix"),EntityManager:Symbol.for("EntityManager"),GameConfig:Symbol.for("GameConfig"),InputManager:Symbol.for("InputManager"),LoopManager:Symbol.for("LoopManager"),RenderManager:Symbol.for("RenderManager"),SceneManager:Symbol.for("SceneManager"),SystemFactory:Symbol.for("SystemFactory"),SystemManager:Symbol.for("SystemManager"),TimeManager:Symbol.for("TimeManager"),WebGLManager:Symbol.for("WebGLManager")};class e{constructor(){this.instances=new Map,this.types=new Map}add(t,e){if(!e&&!t.prototype.__ioc_injectable)throw new Error(`Type ${t.name} is not injectable`);return this.types.set(null!=e?e:t.prototype.__ioc_injectable,t),this}set(t,e){return this.instances.set(t,e),this}get(t){var e,i;if(!this.instances.has(t)){const s=this.types.get(t);if(!s)throw new Error(`${t.toString()} is not a valid type`);const o=new s(...(null!==(e=s.prototype.__ioc_inject_constructor)&&void 0!==e?e:[]).map((t=>this.get(t))));(null!==(i=s.prototype.__ioc_inject_prop)&&void 0!==i?i:[]).forEach((([t,e])=>o[t]=this.get(e))),this.instances.set(t,o)}return this.instances.get(t)}has(t){return this.types.has(t)||this.instances.has(t)}}function i(t){return function(e){e.prototype.__ioc_injectable&&e.prototype.__ioc_injectable===t||(e.prototype.__ioc_injectable=t)}}function s(t){return function(e,i,s){void 0!==s?(e.prototype.__ioc_inject_constructor||(e.prototype.__ioc_inject_constructor=[]),e.prototype.__ioc_inject_constructor[s]=t):void 0!==i&&(e.constructor.prototype.__ioc_inject_prop||(e.constructor.prototype.__ioc_inject_prop=[]),e.constructor.prototype.__ioc_inject_prop.push([i,t]))}}var o;function r(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a}function a(t,e){return function(i,s){e(i,s,t)}}!function(t){t[t.QuadTree=0]="QuadTree",t[t.SpartialGrid=1]="SpartialGrid"}(o||(o={})),"function"==typeof SuppressedError&&SuppressedError;class n{constructor(t=0,e=0){this._x=t,this._y=e}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get magnitude(){return Math.sqrt(Math.pow(this._x,2)+Math.pow(this._y,2))}get direction(){return this._direction||(this._direction=new n),n.unit(this._direction,this)}set(t,e){this._x=t,this._y=e}copy(t){this.set(t.x,t.y)}equals(t){return this._x===t.x&&this._y===t.y}clone(){return new n(this._x,this._y)}distance(t){return Math.sqrt(Math.pow(this._x-t.x,2)+Math.pow(this._y-t.y,2))}static add(t,e,i){return t.set(e.x+i.x,e.y+i.y),t}static subtract(t,e,i){return t.set(e.x-i.x,e.y-i.y),t}static unit(t,e){return 0===e.magnitude?t.set(0,0):t.set(e.x/e.magnitude,e.y/e.magnitude),t}static normal(t,e){return t.set(-e.y,e.x),this.unit(t,t)}static scale(t,e,i){return t.set(e.x*i,e.y*i),t}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e){return t.x*e.y-t.y*e.x}static round(t,e){return t.set(Math.round(e.x),Math.round(e.y)),t}}class h{constructor(t=0,e=0,i=0,s=0){this.width=0,this.height=0,this._position=new n,this._center=new n,this.set(t,e,i,s)}get x(){return this._position.x}set x(t){this._position.set(t,this._position.y)}get y(){return this._position.y}set y(t){this._position.set(this._position.x,t)}get x1(){return this._position.x+this.width}get y1(){return this._position.y+this.height}get position(){return this._position}set position(t){this._position.set(t.x,t.y)}get center(){return this._center.set(this.x+this.width/2,this.y+this.height/2),this._center}set(t,e,i,s){this._position.set(t,e),this.width=i,this.height=s}equals(t){return this.position.equals(t.position)&&this.width===t.width&&this.height===t.height}copy(t){this.set(t.x,t.y,t.width,t.height)}overlaps(t){return this.x1>=t.x&&this.x<t.x1&&this.y1>=t.y&&this.y<t.y1}contains(t){return t instanceof h?t.x1<=this.x1&&t.x>=this.x&&t.y1<=this.y1&&t.y>=this.y:t instanceof n&&!(t.x<this.x||t.y<this.y||t.x>=this.x1||t.y>=this.y1)}}const l=(t,e,i)=>Math.min(i,Math.max(e,t)),c=(t,e,i)=>t>=e&&t<=i;var d;let m=d=class{constructor(t=new h,e=0){this.children=[],this.shapes=[],this.minArea=new n,this.maxArea=new n,this.area=t,this.depth=e}clear(){this.shapes=[],this.children=[]}update(t){this.clear(),this.resizeArea(t),t.forEach((({id:t,boundingBox:e})=>this.insert(t,e)))}resizeArea(t){this.minArea.set(0,0),this.maxArea.set(0,0),t.forEach((({boundingBox:t})=>{this.minArea.set(Math.min(t.x,this.minArea.x),Math.min(t.y,this.minArea.y)),this.maxArea.set(Math.max(t.x1,this.maxArea.x),Math.max(t.y1,this.maxArea.y))})),this.area.set(this.minArea.x,this.minArea.y,this.maxArea.x-this.minArea.x,this.maxArea.y-this.minArea.y)}retrieve(t){const e=[];return this.children.length>0?this.getChildrenForBox(t).forEach((i=>e.push(...i.retrieve(t).filter((t=>!e.includes(t)))))):this.shapes.forEach((t=>e.push(t[0]))),e}insert(t,e){0===this.children.length&&this.shapes.length>16&&this.depth<8&&this.split(),this.children.length>0?this.insertItemIntoChildren(t,e):this.shapes.push([t,e])}split(){const t=this.area.width/2,e=this.area.height/2;this.children=[new h(this.area.x,this.area.y,t,e),new h(this.area.x,this.area.y+e,t,e),new h(this.area.x+t,this.area.y+e,t,e),new h(this.area.x+t,this.area.y,t,e)].map((t=>new d(t,this.depth+1))),this.shapes.forEach((t=>this.insertItemIntoChildren(t[0],t[1]))),this.shapes=[]}insertItemIntoChildren(t,e){this.getChildrenForBox(e).forEach((i=>i.insert(t,e)))}getChildrenForBox(t){const e=[];return t.x<=this.area.center.x&&t.y<=this.area.center.y&&e.push(this.children[0]),t.x<=this.area.center.x&&t.y1>=this.area.center.y&&e.push(this.children[1]),t.x1>=this.area.center.x&&t.y1>=this.area.center.y&&e.push(this.children[2]),t.x1>=this.area.center.x&&t.y<=this.area.center.y&&e.push(this.children[3]),e}};m=d=r([i(t.CollisionBroadphaseResolver)],m);const g=(t,e,i,s)=>Math.min((t-e)/i|0,s-1);let u=class{constructor(){this.area=new h,this.colliders=[],this.subdivisions=0,this.coordinates={x0:0,x1:0,y0:0,y1:0},this.minArea=new n,this.maxArea=new n}clear(){for(let t=0;t<this.subdivisions;t++)for(let e=0;e<this.subdivisions;e++)this.colliders[t][e]=[]}update(t){this.resizeArea(t),this.updateSubdivisions(t.length),t.forEach((({id:t,boundingBox:e})=>this.insert(t,e)))}resizeArea(t){this.minArea.set(0,0),this.maxArea.set(0,0),t.forEach((({boundingBox:t})=>{this.minArea.set(Math.min(t.x,this.minArea.x),Math.min(t.y,this.minArea.y)),this.maxArea.set(Math.max(t.x1,this.maxArea.x),Math.max(t.y1,this.maxArea.y))})),this.area.set(this.minArea.x,this.minArea.y,this.maxArea.x-this.minArea.x,this.maxArea.y-this.minArea.y)}updateSubdivisions(t){this.subdivisions=1+(t/10|0),this.cellWidth=Math.ceil(this.area.width/this.subdivisions),this.cellHeight=Math.ceil(this.area.height/this.subdivisions),this.colliders=[];for(let t=0;t<this.subdivisions;t++){this.colliders[t]=[];for(let e=0;e<this.subdivisions;e++)this.colliders[t][e]=[]}}insert(t,e){this.updateCoordinates(e);for(let e=this.coordinates.x0;e<=this.coordinates.x1;e++)for(let i=this.coordinates.y0;i<=this.coordinates.y1;i++)this.colliders[e][i].push(t)}retrieve(t){const e=[];this.updateCoordinates(t);for(let t=this.coordinates.x0;t<=this.coordinates.x1;t++)for(let i=this.coordinates.y0;i<=this.coordinates.y1;i++)this.colliders[t][i].forEach((t=>e.includes(t)?void 0:e.push(t)));return e}updateCoordinates(t){this.coordinates.x0=g(t.x,this.area.x,this.cellWidth,this.subdivisions),this.coordinates.x1=g(t.x1,this.area.x,this.cellWidth,this.subdivisions),this.coordinates.y0=g(t.y,this.area.y,this.cellHeight,this.subdivisions),this.coordinates.y1=g(t.y1,this.area.y,this.cellHeight,this.subdivisions)}};u=r([i(t.CollisionBroadphaseResolver)],u);class p{get vertexModel(){return this._vertexModel}set vertexModel(t){if(this._vertexModel=t,2===t.length)return this.vertices=[new n,new n],void(this.projectionAxes=[new n]);this.vertices=[],this.projectionAxes=[],this._vertexModel.forEach((()=>{this.vertices.push(new n),this.projectionAxes.push(new n)}))}constructor(t,e=0){this.rotation=e,this.boundingBox=new h,this.collider=void 0,this.entity=void 0,this.id=void 0,this.ignoreCollisionsWithLayers=void 0,this.layer=void 0,this.position=new n,this.projectionAxes=[],this.radius=0,this.vertices=[],this.updateCollisions=!0,this._vertexModel=[],this.vertexModel=t}}class y{constructor(t){this.radius=t,this.boundingBox=new h,this.collider=void 0,this.entity=void 0,this.id=void 0,this.ignoreCollisionsWithLayers=void 0,this.layer=void 0,this.position=new n,this.projectionAxes=[new n],this.rotation=0,this.vertexModel=[],this.vertices=[new n,new n],this.updateCollisions=!0}}let f=class{constructor(t,e,i){this.AABBResolver=t,this.circumferenceAABBResolver=e,this.circumferenceResolver=i}findCollision(t,e){return t instanceof p&&e instanceof p?this.AABBResolver.resolve(t,e):t instanceof y&&e instanceof p?this.circumferenceAABBResolver.resolve(t,e):t instanceof p&&e instanceof y?this.circumferenceAABBResolver.resolve(e,t,!0):t instanceof y&&e instanceof y?this.circumferenceResolver.resolve(t,e):void 0}};var x;f=r([i(t.CollisionResolutionMethod),a(0,s(t.CollisionAABBResolver)),a(1,s(t.CollisionCircumferenceAABBResolver)),a(2,s(t.CollisionCircumferenceResolver))],f),function(t){t[t.AABB=0]="AABB",t[t.SAT=1]="SAT"}(x||(x={}));let M=class{constructor(t,e){this.circumferenceResolver=t,this.satResolver=e}findCollision(t,e){return t instanceof y&&e instanceof y?this.circumferenceResolver.resolve(t,e):this.satResolver.resolve(t,e)}};M=r([i(t.CollisionResolutionMethod),a(0,s(t.CollisionCircumferenceResolver)),a(1,s(t.CollisionSatResolver))],M);let v=class{constructor(){this.direction=new n,this.resolutionDirection=new n}resolve({boundingBox:t},{boundingBox:e}){if(this.overlapX=Math.min(t.x1,e.x1)-Math.max(t.x,e.x),this.overlapY=Math.min(t.y1,e.y1)-Math.max(t.y,e.y),!(this.overlapX<0||this.overlapY<0))return this.checkOverlapForLines(t,e),this.direction.set(Math.sign(e.center.x-t.center.x),Math.sign(e.center.y-t.center.y)),this.preventContainment(t,e),this.overlapY<this.overlapX?(this.minOverlap=this.overlapY,this.resolutionDirection.set(0,this.direction.y)):(this.minOverlap=this.overlapX,this.resolutionDirection.set(this.direction.x,this.overlapY===this.overlapX?this.direction.y:0)),{direction:n.unit(new n,this.resolutionDirection),penetration:this.minOverlap}}checkOverlapForLines(t,e){0!==t.width&&0!==e.width||0!==this.overlapX||(this.overlapX=Math.min(Math.abs(t.x-e.x),Math.abs(t.x1-e.x1))),0!==t.height&&0!==e.height||0!==this.overlapY||(this.overlapY=Math.min(Math.abs(t.y-e.y),Math.abs(t.y1-e.y1)))}preventContainment(t,e){if(this.overlapY>0&&(t.y1>e.y1&&t.y<e.y||t.y1<e.y1&&t.y>e.y)){const i=Math.abs(t.y-e.y),s=Math.abs(t.y1-e.y1);this.overlapY+=i<s?i:s}if(this.overlapX>0&&(t.x1>e.x1&&t.x<e.x||t.x1<e.x1&&t.x>e.x)){const i=Math.abs(t.x-e.x),s=Math.abs(t.x1-e.x1);this.overlapX+=i<s?i:s}}};v=r([i(t.CollisionAABBResolver)],v);let S=class{constructor(){this.closestPoint=new n,this.distance=new n,this.direction=new n}resolve(t,e,i=!1){if(this.closestPoint.set(l(t.position.x,e.boundingBox.x,e.boundingBox.x1),l(t.position.y,e.boundingBox.y,e.boundingBox.y1)),n.subtract(this.distance,this.closestPoint,t.position),!(this.distance.magnitude>t.radius))return n.unit(this.direction,this.distance),{direction:i?n.scale(new n,this.direction,-1):this.direction.clone(),penetration:t.radius-this.distance.magnitude}}};S=r([i(t.CollisionCircumferenceAABBResolver)],S);let C=class{constructor(){this.distance=new n,this.direction=new n}resolve(t,e){if(n.subtract(this.distance,e.position,t.position),!(this.distance.magnitude>t.radius+e.radius))return n.unit(this.direction,this.distance),{direction:this.direction.clone(),penetration:t.radius+e.radius-this.distance.magnitude}}};C=r([i(t.CollisionCircumferenceResolver)],C);let b=class{constructor(){this.projA={min:0,max:0},this.projB={min:0,max:0},this.smallestAxis=new n,this.distance=new n(1/0,1/0),this.cache=new n}resolve(t,e){this.minOverlap=1/0,t instanceof y?this.setCircumferenceAxis(t,e):e instanceof y&&this.setCircumferenceAxis(e,t),this.axes=[...t.projectionAxes],e.projectionAxes.forEach((t=>this.axes.some((e=>e.equals(t)))?void 0:this.axes.push(t)));for(let i=0;i<this.axes.length;i++){if(t instanceof y?this.setCircumferenceVertices(t,this.axes[i]):e instanceof y&&this.setCircumferenceVertices(e,this.axes[i]),this.projectShapeOntoAxis(this.projA,t,this.axes[i]),this.projectShapeOntoAxis(this.projB,e,this.axes[i]),this.currentOverlap=Math.min(this.projA.max,this.projB.max)-Math.max(this.projA.min,this.projB.min),this.currentOverlap<0)return;if(this.invertAxis=!0,this.projA.max>this.projB.max&&this.projA.min<this.projB.min||this.projA.max<this.projB.max&&this.projA.min>this.projB.min){const t=Math.abs(this.projA.min-this.projB.min),e=Math.abs(this.projA.max-this.projB.max);t<e?this.currentOverlap+=t:(this.currentOverlap+=e,n.scale(this.axes[i],this.axes[i],-1),this.invertAxis=!1)}this.currentOverlap<this.minOverlap&&(this.minOverlap=this.currentOverlap,this.smallestAxis.copy(this.axes[i]),this.invertAxis&&this.projA.max<this.projB.max&&n.scale(this.smallestAxis,this.axes[i],-1))}return{direction:n.scale(new n,this.smallestAxis,-1),penetration:this.minOverlap}}projectShapeOntoAxis(t,e,i){return t.min=1/0,t.max=-1/0,e.vertices.forEach((e=>{t.min=Math.min(n.dot(i,e),t.min),t.max=Math.max(n.dot(i,e),t.max)})),t}setCircumferenceAxis(t,e){this.distance.set(1/0,1/0),e.vertices.forEach((e=>{n.subtract(this.cache,e,t.position),this.cache.magnitude<this.distance.magnitude&&this.distance.copy(this.cache)})),n.unit(t.projectionAxes[0],this.distance)}setCircumferenceVertices(t,e){n.add(t.vertices[0],t.position,n.scale(this.cache,n.unit(this.cache,e),-t.radius)),n.add(t.vertices[1],t.position,n.scale(this.cache,n.unit(this.cache,e),t.radius))}};b=r([i(t.CollisionSatResolver)],b);let w=class{constructor(){this.collisions=[]}findCollisionsForCollider(t){return this.collisions.filter((e=>e.localCollider===t))}findCollisionsForColliderAndLayer(t,e){return this.collisions.filter((i=>i.localCollider===t&&i.remoteCollider.layer===e))}findAll(){return this.collisions}persist(t){this.collisions.push(t)}removeAll(){this.collisions=[]}};w=r([i(t.CollisionRepository)],w);let E=class{constructor(){this.lastEntityId=0,this.lastComponentTypeId=0,this.components=new Map,this.disabledEntities=new Set,this.disabledComponents=new Map}createEntity(t){return this.lastEntityId++,t&&t.forEach((t=>this.addComponent(this.lastEntityId,t))),this.lastEntityId}removeEntity(t){this.components.forEach((e=>{e.has(t)&&e.delete(t)})),this.disabledComponents.delete(t),this.disabledEntities.delete(t)}removeAllEntities(){this.components.clear(),this.disabledComponents.clear(),this.disabledEntities.clear(),this.lastEntityId=0}isEntityEnabled(t){return!this.disabledEntities.has(t)}enableEntity(t){this.disabledEntities.delete(t)}disableEntity(t){this.disabledEntities.add(t)}disableEntitiesByComponent(t){var e,i;for(const s of null!==(i=null===(e=this.components.get(this.getComponentTypeId(t)))||void 0===e?void 0:e.keys())&&void 0!==i?i:[])this.disableEntity(s)}enableEntitiesByComponent(t){var e,i;for(const s of null!==(i=null===(e=this.components.get(this.getComponentTypeId(t)))||void 0===e?void 0:e.keys())&&void 0!==i?i:[])this.enableEntity(s)}addComponent(t,e){const i=this.getComponentTypeId(e),s="object"==typeof e?e:new e;if(this.components.has(i)||this.components.set(i,new Map),this.components.get(i).has(t))throw new Error(`Entity ${t} already has a component of type ${i}`);return this.components.get(i).set(t,s),s}hasComponent(t,e){return void 0!==this.getComponent(t,e)}getComponent(t,e){var i;return null===(i=this.components.get(this.getComponentTypeId(e)))||void 0===i?void 0:i.get(t)}getComponents(t){const e=[];return this.components.forEach((i=>i.forEach(((i,s)=>{t===s&&e.push(i)})))),e}getEntityForComponent(t){const e=this.getComponentTypeId(t);if(this.components.has(e))for(const[i,s]of this.components.get(e))if(s===t)return i}removeComponent(t,e){var i;const s=this.getComponentTypeId("object"==typeof t?t:e),o="number"==typeof t?t:this.getEntityForComponent(t);(null===(i=this.components.get(s))||void 0===i?void 0:i.has(o))&&this.components.get(s).delete(o)}isComponentEnabled(t,e){var i,s;const o=this.getComponentTypeId("object"==typeof t?t:e),r="number"==typeof t?t:this.getEntityForComponent(t);return null===(s=!(null===(i=this.disabledComponents.get(r))||void 0===i?void 0:i.has(o)))||void 0===s||s}disableComponent(t,e){const i="number"==typeof t?t:this.getEntityForComponent(t),s=this.getComponentTypeId("object"==typeof t?t:e);this.disabledComponents.has(i)?this.disabledComponents.get(i).has(s)||this.disabledComponents.get(i).add(s):this.disabledComponents.set(i,new Set([s]))}enableComponent(t,e){var i;const s="number"==typeof t?t:this.getEntityForComponent(t),o=this.getComponentTypeId("object"==typeof t?t:e);(null===(i=this.disabledComponents.get(s))||void 0===i?void 0:i.has(o))&&this.disabledComponents.get(s).delete(o)}search(t,e,i=!1){const s=[],o=this.getComponentTypeId(t);return this.components.has(o)&&this.components.get(o).forEach(((o,r)=>{e&&!Object.keys(e).every((t=>o[t]===e[t]))||!(i||this.isEntityEnabled(r)&&this.isComponentEnabled(r,t))||s.push({entity:r,component:o})})),s}searchEntitiesByComponents(t){const e=[];let i=!0;for(const s of t){const t=this.getComponentTypeId(s);if(!t||!this.components.has(t))return[];if(i){e.push(...this.components.get(t).keys()),i=!1;continue}const o=new Set(this.components.get(t).keys());e.forEach(((t,i)=>{o.has(t)||e.splice(i,1)}))}return e}getComponentTypeId(t){const e="object"==typeof t?t.constructor.prototype:t.prototype;return void 0===e.__ecs_type_id&&(e.__ecs_type_id=++this.lastComponentTypeId),e.__ecs_type_id}};E=r([i(t.EntityManager)],E);let _=class{constructor(){this.systems=[]}findSystemIndex(t){return this.systems.findIndex((e=>e[0]instanceof t))}addSystem(t,e){if(this.systems.some((t=>t[0]instanceof t.constructor)))throw new Error(`SystemManager already has an instance of ${t.constructor.name}.`);this.systems.push([t,e,!1,!1])}hasSystem(t){return this.systems.some((e=>e[0]instanceof t))}getSystem(t){const e=this.findSystemIndex(t);return-1!==e?this.systems[e][0]:void 0}enableSystem(t){const e=this.findSystemIndex(t);if(-1===e||!0===this.systems[e][2])return;const i=this.systems[e];!1===i[3]&&(i[3]=!0,i[0].onCreate&&i[0].onCreate()),i[2]=!0,i[0].onEnabled&&i[0].onEnabled()}disableSystem(t){const e=this.findSystemIndex(t);if(-1===e||!1===this.systems[e][2])return;const i=this.systems[e];i[2]=!1,i[0].onDisabled&&i[0].onDisabled()}setExecutionOrder(t,e){const i=this.findSystemIndex(t);if(-1===i)throw new Error(`Cannot set execution order because ${t.name} is not a system.`);this.systems.splice(e,0,this.systems.splice(i,1)[0])}removeSystem(t){const e=this.findSystemIndex(t);if(-1===e)return;const i=this.systems.splice(e,1)[0][0];i.onDestroy&&i.onDestroy()}update(t){this.systems.filter((e=>e[1]===t&&!0===e[2])).forEach((t=>t[0].onUpdate()))}};_=r([i(t.SystemManager)],_);class R{constructor(){this.buttons=new Map,this.axes=new Map,this._dpadAxes=new n,this._leftStickAxes=new n,this._rightStickAxes=new n}get dpadAxes(){return this._dpadAxes.set(this.dpadRight?1:this.dpadLeft?-1:0,this.dpadUp?1:this.dpadDown?-1:0),this._dpadAxes}get leftStickAxes(){return this._leftStickAxes.set(this.leftStickHorizontal,this.leftStickVertical),this._leftStickAxes}get rightStickAxes(){return this._rightStickAxes.set(this.rightStickHorizontal,this.rightStickVertical),this._rightStickAxes}get dpadUp(){var t;return null!==(t=this.buttons.get(12))&&void 0!==t&&t}get dpadDown(){var t;return null!==(t=this.buttons.get(13))&&void 0!==t&&t}get dpadLeft(){var t;return null!==(t=this.buttons.get(14))&&void 0!==t&&t}get dpadRight(){var t;return null!==(t=this.buttons.get(15))&&void 0!==t&&t}get bottomFace(){var t;return null!==(t=this.buttons.get(0))&&void 0!==t&&t}get rightFace(){var t;return null!==(t=this.buttons.get(1))&&void 0!==t&&t}get leftFace(){var t;return null!==(t=this.buttons.get(2))&&void 0!==t&&t}get topFace(){var t;return null!==(t=this.buttons.get(3))&&void 0!==t&&t}get leftShoulder(){var t;return null!==(t=this.buttons.get(4))&&void 0!==t&&t}get rightShoulder(){var t;return null!==(t=this.buttons.get(5))&&void 0!==t&&t}get leftTrigger(){var t;return null!==(t=this.buttons.get(6))&&void 0!==t&&t}get rightTrigger(){var t;return null!==(t=this.buttons.get(7))&&void 0!==t&&t}get back(){var t;return null!==(t=this.buttons.get(8))&&void 0!==t&&t}get start(){var t;return null!==(t=this.buttons.get(9))&&void 0!==t&&t}get leftStickButton(){var t;return null!==(t=this.buttons.get(10))&&void 0!==t&&t}get rightStickButton(){var t;return null!==(t=this.buttons.get(11))&&void 0!==t&&t}get leftStickHorizontal(){var t;return null!==(t=this.axes.get(0))&&void 0!==t?t:0}get leftStickVertical(){var t;return-(null!==(t=this.axes.get(1))&&void 0!==t?t:0)}get rightStickHorizontal(){var t;return null!==(t=this.axes.get(2))&&void 0!==t?t:0}get rightStickVertical(){var t;return-(null!==(t=this.axes.get(3))&&void 0!==t?t:0)}get anyButtonPressed(){var t;return null!==(t=Array.from(this.buttons.values()).find((t=>t)))&&void 0!==t&&t}vibrate(t=200,e=.2,i=.2,s=0){this.vibrationInput={duration:t,weakMagnitude:e,startDelay:s,strongMagnitude:i}}}class A{constructor(){this.pressedKeys=[]}isPressed(t){return this.pressedKeys.includes(t)}orPressed(t){return t.reduce(((t,e)=>t||this.pressedKeys.includes(e)),!1)}andPressed(t){return t.reduce(((t,e)=>t&&this.pressedKeys.includes(e)),!0)}isPressedReturn(t,e,i){return this.pressedKeys.includes(t)?e:i}orPressedReturn(t,e,i){return t.reduce(((t,e)=>t||this.pressedKeys.includes(e)),!1)?e:i}andPressedReturn(t,e,i){return t.reduce(((t,e)=>t&&this.pressedKeys.includes(e)),!0)?e:i}}class T{constructor(){this.leftButtonPressed=!1,this.scrollButtonPressed=!1,this.rightButtonPressed=!1,this.positionInViewport=new n,this.hasMoved=!1,this.wheelScroll=new n}}class D{constructor(){this.touching=!1,this.interactions=[]}}let B=class{constructor(){this.keyboard=new A,this.mouse=new T,this.touchScreen=new D,this.gamepads=[]}};B=r([i(t.InputManager)],B);const P=[60,120,180,240];let U=class{get deltaTime(){return this.unscaledDeltaTime*this.timeScale}get physicsDeltaTime(){return this.unscaledPhysicsDeltaTime*this.timeScale}get renderDeltaTime(){return this.browserDeltaTime*this.timeScale}constructor({physicsFramerate:t}){if(this.timeScale=1,this.browserDeltaTime=0,this.unscaledDeltaTime=0,this.unscaledPhysicsDeltaTime=0,this.maxDeltaTime=1/30,this.thenForGame=0,this.thenForPhysics=0,this.thenForRender=0,t&&!P.includes(t))throw new Error(`Invalid Physics frame rate. Allowed: [${P.join(", ")}]`);this.fixedGameFramerate=60,this.fixedGameDeltaTime=parseFloat((1/this.fixedGameFramerate).toFixed(6)),this.fixedPhysicsFramerate=null!=t?t:180,this.fixedPhysicsDeltaTime=parseFloat((1/this.fixedPhysicsFramerate).toFixed(6))}updateForRender(t){this.browserDeltaTime=Math.min(Math.max(0,t-this.thenForRender),this.maxDeltaTime),this.thenForRender=t}updateForGame(t){this.unscaledDeltaTime=Math.min(Math.max(this.fixedGameDeltaTime,t-this.thenForGame),this.maxDeltaTime),this.thenForGame=t}updateForPhysics(t){this.unscaledPhysicsDeltaTime=Math.min(Math.max(0,t-this.thenForPhysics),this.maxDeltaTime),this.thenForPhysics=t}};var F;U=r([i(t.TimeManager),a(0,s(t.GameConfig))],U),function(t){t[t.Image=0]="Image",t[t.Audio=1]="Audio",t[t.Font=2]="Font",t[t.Video=3]="Video"}(F||(F={}));let L=class{constructor(){this.assets=[]}getAssetsLoaded(){return this.assets.reduce(((t,e)=>t&&e.loaded),!0)}loadImage(t){const e=new Image;e.crossOrigin="",e.src=t;const i=this.createAsset(t,F.Image,e),s=()=>i.loaded=!0;return e.complete?s():e.addEventListener("load",s),e}loadAudio(t){const e=new Audio;e.src=t;const i=this.createAsset(t,F.Audio,e);return e.duration?i.loaded=!0:e.addEventListener("canplaythrough",(()=>i.loaded=!0)),e}loadFont(t,e){const i=new FontFace(t,`url(${e})`),s=this.createAsset(e,F.Font,i);return s.family=t,document.fonts.add(i),i.load().then((()=>s.loaded=!0)),i}loadVideo(t){const e=document.createElement("video");e.playsInline=!0,e.src=t;const i=this.createAsset(t,F.Video,e);return e.duration?i.loaded=!0:e.addEventListener("canplaythrough",(()=>i.loaded=!0)),e}getImage(t){var e;return null===(e=this.assets.find((e=>e.type===F.Image&&e.url===t)))||void 0===e?void 0:e.element}getAudio(t){var e;return null===(e=this.assets.find((e=>e.type===F.Audio&&e.url===t)))||void 0===e?void 0:e.element}getFont(t){var e;return null===(e=this.assets.find((e=>e.type===F.Font&&e.family===t)))||void 0===e?void 0:e.element}getVideo(t){var e;return null===(e=this.assets.find((e=>e.type===F.Video&&e.url===t)))||void 0===e?void 0:e.element}createAsset(t,e,i){const s={type:e,url:t,element:i,loaded:!1};return this.assets.push(s),s}};L=r([i(t.AssetManager)],L);class I{constructor(t){this.action="stop",this.loop=!1,this.playing=!1,this.volume=1,this._currentAudio=void 0,Object.assign(this,t)}}const j={AudioPlayerSystem:Symbol.for("AudioPlayerSystem"),ButtonSystem:Symbol.for("ButtonSystem"),ChildrenSystem:Symbol.for("ChildrenSystem"),ParentSystem:Symbol.for("ParentSystem"),TiledWrapperSystem:Symbol.for("TiledWrapperSystem"),TilemapPreProcessingSystem:Symbol.for("TilemapPreProcessingSystem"),TransformSystem:Symbol.for("TransformSystem"),GamepadSystem:Symbol.for("GamepadSystem"),KeyboardSystem:Symbol.for("KeyboardSystem"),MouseSystem:Symbol.for("MouseSystem"),TouchScreenSystem:Symbol.for("TouchScreenSystem"),UpdateBallColliderShapeSystem:Symbol.for("UpdateBallColliderShapeSystem"),UpdateBoxColliderShapeSystem:Symbol.for("UpdateBoxColliderShapeSystem"),UpdateEdgeColliderShapeSystem:Symbol.for("UpdateEdgeColliderShapeSystem"),UpdatePolygonColliderShapeSystem:Symbol.for("UpdatePolygonColliderShapeSystem"),UpdateTilemapColliderShapeSystem:Symbol.for("UpdateTilemapColliderShapeSystem"),UpdateCollidersAfterRepositionSystem:Symbol.for("UpdateCollidersAfterRepositionSystem"),ApplyRepositionSystem:Symbol.for("ApplyRepositionSystem"),ApplyVelocitySystem:Symbol.for("ApplyVelocitySystem"),ResolveCollisionSystem:Symbol.for("ResolveCollisionSystem"),AnimatorSystem:Symbol.for("AnimatorSystem"),CameraSystem:Symbol.for("CameraSystem"),ClearScreenSystem:Symbol.for("ClearScreenSystem"),ColliderRenderSystem:Symbol.for("ColliderRenderSystem"),CullingSystem:Symbol.for("CullingSystem"),MaskRendererSystem:Symbol.for("MaskRendererSystem"),RenderSystem:Symbol.for("RenderSystem"),ShadowLightRendererSystem:Symbol.for("ShadowLightRendererSystem"),SpriteRendererSystem:Symbol.for("SpriteRendererSystem"),TextRendererSystem:Symbol.for("TextRendererSystem"),TilemapRendererSystem:Symbol.for("TilemapRendererSystem"),VideoRendererSystem:Symbol.for("VideoRendererSystem")},k=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","pointerup","touchend","keydown","keyup"];let O=class{constructor(t,e,i){this.entityManager=t,this.inputManager=e,this.timeManager=i,this.canPlay=!1,this.userInputEventHandler=()=>{k.forEach((t=>{window.removeEventListener(t,this.userInputEventHandler)})),this.canPlay=!0}}onCreate(){this.canPlay=!1,k.forEach((t=>window.addEventListener(t,this.userInputEventHandler))),document.addEventListener("visibilitychange",(()=>{this.entityManager.search(I).forEach((({component:{audioSource:t,playing:e}})=>{document.hidden&&t?t.pause():!document.hidden&&t&&e&&t.play()}))}))}checkGamepad(){return this.canPlay=this.inputManager.gamepads.some((t=>t.anyButtonPressed)),this.canPlay}onUpdate(){(this.canPlay||this.checkGamepad())&&this.entityManager.search(I).forEach((({component:t})=>{t.audioSource&&t.audioSource.duration&&(t.audioSource.loop=t.loop,t.audioSource.volume=t.volume,t.audioSource.src!==t._currentAudio&&(t._currentAudio=t.audioSource.src,t.playing=!1,t.audioSource.currentTime=0),"play"!==t.action||t.playing?"pause"===t.action&&t.playing?(t.audioSource.pause(),t.playing=!1):"stop"!==t.action||t.audioSource.paused&&0===t.audioSource.currentTime?t.playing&&t.audioSource.paused&&(t.action="stop",t.playing=!1):(t.audioSource.pause(),t.audioSource.currentTime=0,t.playing=!1):(t.audioSource.playbackRate=this.timeManager.timeScale<.0625?0:Math.min(this.timeManager.timeScale,16),t.audioSource.play().then((()=>t.playing=!0)).catch((()=>{}))))}))}onDisable(){this.entityManager.search(I).forEach((({component:{audioSource:t}})=>{t&&(t.pause(),t.currentTime=0)}))}onDestroy(){this.onDisable()}};var V;O=r([i(j.AudioPlayerSystem),a(0,s(t.EntityManager)),a(1,s(t.InputManager)),a(2,s(t.TimeManager))],O),function(t){t[t.GameLogic=0]="GameLogic",t[t.GamePhysics=1]="GamePhysics",t[t.GamePreRender=2]="GamePreRender",t[t.Physics=3]="Physics",t[t.PostGameLogic=4]="PostGameLogic",t[t.PreGameLogic=5]="PreGameLogic",t[t.Render=6]="Render"}(V||(V={}));class G{get parent(){return this._parent}set parent(t){this._parent!==t&&(this._parent=t,this._parent?(this.localPosition.copy(this.position),n.subtract(this.position,this.position,this._parent.position)):this.position.copy(this.localPosition))}constructor(t){this.position=new n,this.scale=new n(1,1),this.rotation=0,this.localPosition=new n,this.localScale=new n(1,1),this.localRotation=0,this._childEntities=[],this._parent=void 0,t&&t.parent&&(this.position=t.parent.position.clone(),this.parent=t.parent,delete t.parent),Object.assign(this,t)}}const W="Default";class N{constructor(t){this.layers=[W],this.zoom=1,this.depth=0,this._renderData={position:new n,depth:0,zoom:1,layers:[]},Object.assign(this,t)}}var z;!function(t){t.LegacyWebGL="webgl",t.WebGL2="webgl2"}(z||(z={}));class H{constructor(t){if(this.canvas=t,this.contextVersion=this.getContextVersion(),!this.contextVersion)throw new Error("Your browser does not support WebGL.");this.gl=this.canvas.getContext(this.contextVersion)}getContextVersion(){return null!==this.canvas.getContext(z.WebGL2)?z.WebGL2:null!==this.canvas.getContext(z.LegacyWebGL)?z.LegacyWebGL:void 0}}class Y{constructor(){this.fontAtlas=new Map}hasFontAtlas(t){return this.fontAtlas.has(this.symbol(t))}getFontAtlas(t){return this.fontAtlas.get(this.symbol(t))}getOrCreate(t,e,i){var s;return null!==(s=this.getFontAtlas(e))&&void 0!==s?s:this.create(t,e,i)}create(t,e,i){this.bitmapSize=i,this.chars=[];for(let e=0;e<t.length;e+=2)for(let i=t[e];i<=t[e+1];i++)this.chars.push(String.fromCharCode(i));const s=this.renderAtlas(e instanceof FontFace?e.family:e);return this.fontAtlas.set(this.symbol(e),s),s}symbol(t){return Symbol.for(t instanceof FontFace?t.family:t)}renderAtlas(t){const e=new X(t,this.bitmapSize,Math.ceil(Math.sqrt(this.chars.length))),i=e.canvas.getContext("2d");i.clearRect(0,0,e.canvas.width,e.canvas.height),i.textBaseline="top",i.fillStyle="#000",i.font=`${this.bitmapSize}px ${t}`;let s=0,o=0;for(let t=0;t<this.chars.length;t++)i.fillText(this.chars[t],s,o),e.glyphs.set(this.chars[t],{id:t,width:i.measureText(this.chars[t]).width}),(s+=this.bitmapSize)>e.canvas.width-this.bitmapSize&&(s=0,o+=this.bitmapSize);return e}}class X{constructor(t,e,i){this.fontFaceFamily=t,this.bitmapFontSize=e,this.gridSize=i,this.canvas=document.createElement("canvas"),this.glyphs=new Map,this.canvas.width=this.gridSize*this.bitmapFontSize,this.canvas.height=this.canvas.width}}class ${constructor(t,e){this.gl=t,this.shaderLoader=e}create(t,e){const i=this.gl.createProgram(),s=this.shaderLoader.load(this.gl.VERTEX_SHADER,t),o=this.shaderLoader.load(this.gl.FRAGMENT_SHADER,e);this.gl.attachShader(i,s),this.gl.attachShader(i,o),this.gl.linkProgram(i);const r=this.gl.LINK_STATUS;if(!this.gl.getProgramParameter(i,r)){const t=this.gl.getProgramInfoLog(i);throw this.gl.deleteProgram(i),new Error(`Unable to initialize the Program: ${t}`)}return i}}class K{constructor(t,e,i){this.gl=t,this.contextVersion=e,this.programFactory=i}loadProgram(){this.program=this.contextVersion===z.WebGL2?this.programFactory.create("#version 300 es\n\nin vec4 positionCoords;\nin vec2 textureCoords;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 textureMatrix;\n\nout vec2 texCoords;\n\nvoid main()\n{\n    gl_Position = projectionMatrix * modelMatrix * positionCoords;\n    texCoords = (textureMatrix * vec4(textureCoords, 0, 1)).xy;\n}","#version 300 es\nprecision highp float;\n\nin vec2 texCoords;\n\n// texture, mask and shadow\nuniform int u_renderTexture;\nuniform sampler2D u_texImage;\nuniform vec4 u_solidColor;\nuniform int u_useTintColor;\nuniform vec4 u_tintColor;\nuniform int u_useMaskColor;\nuniform vec4 u_maskColor;\nuniform float u_maskColorMix;\nuniform float u_alpha;\n\n// light\nstruct Light {\n    vec2 position;\n    float radius;\n    float smoothMode;\n    float intensity;\n};\n\nuniform int u_renderLight;\nuniform Light u_lights[64];\nuniform int u_numLights;\n\nout vec4 fragColor;\n\nvoid main()\n{\n    if (u_renderTexture == 1) {\n        vec4 texColor = texture(u_texImage, texCoords);\n\n        if (texColor.a < 0.0001) {\n            discard;\n        }\n\n        if (u_useTintColor == 1) {\n            texColor = u_tintColor * texColor;\n        }\n\n        if (u_useMaskColor == 1) {\n            texColor = mix(texColor, u_maskColor, clamp(u_maskColorMix, 0.0, 1.0));\n        }\n\n        fragColor = vec4(texColor.rgb, u_alpha * texColor.a);        \n    } else if (u_renderLight == 1) {\n        vec2 fragCoord = gl_FragCoord.xy;\n        float alpha = u_alpha;\n\n        for (int i = 0; i < u_numLights; i++) {\n            Light light = u_lights[i];\n            float dist = distance(fragCoord, light.position);\n        \n            if (dist < light.radius) {\n                alpha -= (light.smoothMode > 0.0 ? smoothstep(light.radius, 0.0, dist) : 1.0) * light.intensity;\n            }\n        }\n\n        alpha = clamp(alpha, 0.0, u_alpha);\n\n        fragColor = vec4(u_solidColor.rgb, alpha);\n    } else {\n        fragColor = vec4(u_solidColor.rgb, u_alpha);\n    }\n}"):this.programFactory.create("precision mediump float;\n\nattribute vec2 positionCoords;\nattribute vec2 textureCoords;\n\nvarying vec2 texCoords;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 textureMatrix;\n\nvoid main()\n{\n    gl_Position = projectionMatrix * modelMatrix * vec4(positionCoords, 0, 1);\n    texCoords = (textureMatrix * vec4(textureCoords, 0, 1)).xy;\n}","precision mediump float;\n\nvarying vec2 texCoords;\n\n// texture, mask and shadow\nuniform int u_renderTexture;\nuniform sampler2D u_texImage;\nuniform vec4 u_solidColor;\nuniform int u_useTintColor;\nuniform vec4 u_tintColor;\nuniform int u_useMaskColor;\nuniform vec4 u_maskColor;\nuniform float u_maskColorMix;\nuniform float u_alpha;\n\n// light\nstruct Light {\n    vec2 position;\n    float radius;\n    float smoothMode;\n    float intensity;\n};\n\nuniform int u_renderLight;\nuniform Light u_lights[10];\nuniform int u_numLights;\n\nvoid main()\n{\n    if (u_renderTexture == 1) {\n        vec4 texColor = texture2D(u_texImage, texCoords);\n\n        if (texColor.a < 0.0001) {\n            discard;\n        }\n\n        if (u_useTintColor == 1) {\n            texColor = u_tintColor * texColor;\n        }\n\n        if (u_useMaskColor == 1) {\n            texColor = mix(texColor, u_maskColor, clamp(u_maskColorMix, 0.0, 1.0));\n        }\n\n        gl_FragColor = vec4(texColor.rgb, u_alpha * texColor.a);\n    } else if (u_renderLight == 1) {\n        vec2 fragCoord = gl_FragCoord.xy;\n        float alpha = u_alpha;\n\n        for (int i = 0; i < u_numLights; i++) {\n            Light light = u_lights[i];\n            float dist = distance(fragCoord, light.position);\n        \n            if (dist < light.radius) {\n                alpha -= (light.smoothMode > 0.0 ? smoothstep(light.radius, 0.0, dist) : 1.0) * light.intensity;\n            }\n        }\n\n        alpha = clamp(alpha, 0.0, u_alpha);\n\n        gl_FragColor = vec4(u_solidColor.rgb, alpha);\n    } else {\n        gl_FragColor =  vec4(u_solidColor.rgb, u_alpha);\n    }\n}"),this.positionBuffer=this.gl.createBuffer(),this.textureBuffer=this.gl.createBuffer(),this.positionCoordsAttr=this.gl.getAttribLocation(this.program,"positionCoords"),this.texCoordsAttr=this.gl.getAttribLocation(this.program,"textureCoords"),this.modelMatrixUniform=this.gl.getUniformLocation(this.program,"modelMatrix"),this.projectionMatrixUniform=this.gl.getUniformLocation(this.program,"projectionMatrix"),this.textureMatrixUniform=this.gl.getUniformLocation(this.program,"textureMatrix"),this.renderTextureUniform=this.gl.getUniformLocation(this.program,"u_renderTexture"),this.textureUniform=this.gl.getUniformLocation(this.program,"u_texImage"),this.solidColorUniform=this.gl.getUniformLocation(this.program,"u_solidColor"),this.useTintColorUniform=this.gl.getUniformLocation(this.program,"u_useTintColor"),this.tintColorUniform=this.gl.getUniformLocation(this.program,"u_tintColor"),this.useMaskColorUniform=this.gl.getUniformLocation(this.program,"u_useMaskColor"),this.maskColorUniform=this.gl.getUniformLocation(this.program,"u_maskColor"),this.maskColorMixUniform=this.gl.getUniformLocation(this.program,"u_maskColorMix"),this.alphaUniform=this.gl.getUniformLocation(this.program,"u_alpha"),this.renderLightUniform=this.gl.getUniformLocation(this.program,"u_renderLight"),this.numLightsUniform=this.gl.getUniformLocation(this.program,"u_numLights"),this.gl.useProgram(this.program),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enableVertexAttribArray(this.positionCoordsAttr),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.vertexAttribPointer(this.positionCoordsAttr,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.texCoordsAttr),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer),this.gl.vertexAttribPointer(this.texCoordsAttr,2,this.gl.FLOAT,!1,0,0)}}class q{constructor(t){this.gl=t}load(t,e){const i=this.gl.createShader(t);this.gl.shaderSource(i,e),this.gl.compileShader(i);const s=this.gl.COMPILE_STATUS;if(!this.gl.getShaderParameter(i,s)){const t=this.gl.getShaderInfoLog(i);throw this.gl.deleteShader(i),new Error(`Unable to initialize the shader program: ${t}`)}return i}}var Q="undefined"!=typeof Float32Array?Float32Array:Array;function J(){var t=new Q(16);return Q!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Z(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function tt(t,e,i){var s,o,r,a,n,h,l,c,d,m,g,u,p=i[0],y=i[1],f=i[2];return e===t?(t[12]=e[0]*p+e[4]*y+e[8]*f+e[12],t[13]=e[1]*p+e[5]*y+e[9]*f+e[13],t[14]=e[2]*p+e[6]*y+e[10]*f+e[14],t[15]=e[3]*p+e[7]*y+e[11]*f+e[15]):(s=e[0],o=e[1],r=e[2],a=e[3],n=e[4],h=e[5],l=e[6],c=e[7],d=e[8],m=e[9],g=e[10],u=e[11],t[0]=s,t[1]=o,t[2]=r,t[3]=a,t[4]=n,t[5]=h,t[6]=l,t[7]=c,t[8]=d,t[9]=m,t[10]=g,t[11]=u,t[12]=s*p+n*y+d*f+e[12],t[13]=o*p+h*y+m*f+e[13],t[14]=r*p+l*y+g*f+e[14],t[15]=a*p+c*y+u*f+e[15]),t}function et(t,e,i){var s=i[0],o=i[1],r=i[2];return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function it(t,e,i){var s=Math.sin(i),o=Math.cos(i),r=e[0],a=e[1],n=e[2],h=e[3],l=e[4],c=e[5],d=e[6],m=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=r*o+l*s,t[1]=a*o+c*s,t[2]=n*o+d*s,t[3]=h*o+m*s,t[4]=l*o-r*s,t[5]=c*o-a*s,t[6]=d*o-n*s,t[7]=m*o-h*s,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});const st=(t,e,i,s)=>{(function(t,e,i,s,o){var r=1/(e-i),a=1/(s-o);t[0]=-2*r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-1,t[11]=0,t[12]=(e+i)*r,t[13]=(o+s)*a,t[14]=-0,t[15]=1})(t=Z(t),-e.canvas.width/2,e.canvas.width/2,-e.canvas.height/2,e.canvas.height/2),et(t,t,[null!=i?i:1,null!=i?i:1,1]),tt(t,t,[-s.x,-s.y,0])},ot=t=>{const e=/^#?([a-f\d]{2})?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[2],16)/256,g:parseInt(e[3],16)/256,b:parseInt(e[4],16)/256,a:void 0!==e[1]?parseInt(e[1],16)/256:1}:null};class rt{constructor(t){this.gl=t}render(t){const e=ot(t);this.gl.clearColor(e.r,e.g,e.b,e.a),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}var at,nt,ht;!function(t){t[t.Polygon=0]="Polygon",t[t.Circumference=1]="Circumference",t[t.Line=2]="Line"}(at||(at={}));class lt{constructor(t,e){this.gl=t,this.programManager=e,this.projectionMatrix=J(),this.modelMatrix=J(),this.textureMatrix=J();const i=2*Math.PI/60;this.circumferenceVertices=new Float32Array(((t,e,i=1)=>{const s=[];for(let t=1;t<=e;t+=i)s.push(t);return s})(0,60,1).reduce(((t,e)=>[...t,Math.cos(e*i),Math.sin(e*i)]),[]))}render(t,e){switch(t.shape){case at.Polygon:this.renderLines(t,e,this.gl.LINE_LOOP);break;case at.Line:this.renderLines(t,e,this.gl.LINES);break;case at.Circumference:this.renderCircumference(t,e);break;default:return!1}return!0}renderLines(t,e,i){var s;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t.vertexModel.reduce(((t,e)=>[...t,e.x,e.y]),[])),this.gl.DYNAMIC_DRAW),this.modelMatrix=Z(this.modelMatrix),tt(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),it(this.modelMatrix,this.modelMatrix,null!==(s=t.rotation)&&void 0!==s?s:0),st(this.projectionMatrix,this.gl,e.zoom,e.position),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:o,g:r,b:a,a:n}=ot(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,o,r,a,n),this.gl.uniform1f(this.programManager.alphaUniform,1),this.gl.drawArrays(i,0,t.vertexModel.length)}renderCircumference(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.circumferenceVertices,this.gl.DYNAMIC_DRAW),this.modelMatrix=Z(this.modelMatrix),tt(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),et(this.modelMatrix,this.modelMatrix,[t.radius,t.radius,1]),st(this.projectionMatrix,this.gl,e.zoom,e.position),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:i,g:s,b:o,a:r}=ot(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,i,s,o,r),this.gl.uniform1f(this.programManager.alphaUniform,1),this.gl.drawArrays(this.gl.LINE_LOOP,0,this.circumferenceVertices.length/2)}}!function(t){t[t.Sprite=0]="Sprite",t[t.Text=1]="Text",t[t.Tilemap=2]="Tilemap",t[t.Mask=3]="Mask",t[t.Geometric=4]="Geometric",t[t.Video=5]="Video",t[t.Shadow=6]="Shadow"}(nt||(nt={})),function(t){t[t.Rectangle=0]="Rectangle",t[t.Circumference=1]="Circumference"}(ht||(ht={}));let ct=class{constructor(t,e){this.gl=t,this.programManager=e,this.type=nt.Mask,this.rectangleVertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.projectionMatrix=J(),this.modelMatrix=J(),this.textureMatrix=J();const i=2*Math.PI/60,s=[0,0];for(let t=0;t<=60;t++)s.push(Math.cos(t*i),Math.sin(t*i));this.circumferenceVertices=new Float32Array(s)}render(t,e,i){var s,o;i===nt.Mask&&this.lastShape===t.shape||(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t.shape===ht.Rectangle?this.rectangleVertices:this.circumferenceVertices,this.gl.STATIC_DRAW)),this.modelMatrix=Z(this.modelMatrix),tt(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),it(this.modelMatrix,this.modelMatrix,null!==(s=t.rotation)&&void 0!==s?s:0),et(this.modelMatrix,this.modelMatrix,t.shape===ht.Rectangle?[t.width,t.height,1]:[t.radius,t.radius,1]),st(this.projectionMatrix,this.gl,e.zoom,e.position),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),t.opacity>=0&&t.opacity<1?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r,g:a,b:n,a:h}=ot(t.color);return this.gl.uniform4f(this.programManager.solidColorUniform,r,a,n,h),this.gl.uniform1f(this.programManager.alphaUniform,null!==(o=t.opacity)&&void 0!==o?o:1),t.shape===ht.Rectangle?this.gl.drawArrays(this.gl.TRIANGLES,0,6):this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,this.circumferenceVertices.length/2),this.lastShape=t.shape,!0}},dt=class{constructor(t,e){this.gl=t,this.programManager=e,this.vertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.projectionMatrix=J(),this.modelMatrix=J(),this.textureMatrix=J()}render(t,e){var i,s;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW),this.modelMatrix=Z(this.modelMatrix),tt(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),it(this.modelMatrix,this.modelMatrix,null!==(i=t.rotation)&&void 0!==i?i:0),et(this.modelMatrix,this.modelMatrix,[t.width,t.height,1]),st(this.projectionMatrix,this.gl,e.zoom,e.position),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND),this.gl.uniform1i(this.programManager.renderTextureUniform,0),this.gl.uniform1i(this.programManager.renderLightUniform,1);const{r:o,g:r,b:a,a:n}=ot(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,o,r,a,n),this.gl.uniform1f(this.programManager.alphaUniform,null!==(s=t.opacity)&&void 0!==s?s:1),this.gl.uniform1i(this.programManager.numLightsUniform,t.lights.length);for(const[i,s]of t.lights.entries()){if(i>=64)break;this.gl.uniform2f(this.gl.getUniformLocation(this.programManager.program,`u_lights[${i}].position`),this.gl.canvas.width/2+(s.position.x-e.position.x)*e.zoom,this.gl.canvas.height/2+(s.position.y-e.position.y)*e.zoom),this.gl.uniform1f(this.gl.getUniformLocation(this.programManager.program,`u_lights[${i}].radius`),s.radius*e.zoom),this.gl.uniform1f(this.gl.getUniformLocation(this.programManager.program,`u_lights[${i}].smoothMode`),s.smooth?1:0),this.gl.uniform1f(this.gl.getUniformLocation(this.programManager.program,`u_lights[${i}].intensity`),Math.max(0,Math.min(1,s.intensity)))}return this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.gl.uniform1i(this.programManager.renderLightUniform,0),!0}},mt=class{constructor(t,e,i){this.gl=t,this.programManager=e,this.textureManager=i,this.lastTexture=null,this.projectionMatrix=J(),this.modelMatrix=J(),this.textureMatrix=J(),this.posVertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.texVertices=new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0])}render(t,e,i){var s,o,r,a;i!==t.type&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.posVertices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.texVertices,this.gl.STATIC_DRAW)),this.modelMatrix=Z(this.modelMatrix),tt(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),it(this.modelMatrix,this.modelMatrix,null!==(s=t.rotation)&&void 0!==s?s:0),et(this.modelMatrix,this.modelMatrix,[t.width*(t.flipHorizontally?-1:1),t.height*(t.flipVertically?-1:1),1]),this.textureMatrix=Z(this.textureMatrix),t.slice&&(tt(this.textureMatrix,this.textureMatrix,[t.slice.x/t.image.naturalWidth,t.slice.y/t.image.naturalHeight,0]),et(this.textureMatrix,this.textureMatrix,[t.slice.width/t.image.naturalWidth,t.slice.height/t.image.naturalHeight,1])),st(this.projectionMatrix,this.gl,e.zoom,e.position),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const n=this.textureManager.getOrCreateTextureFromImage(t.image,t.smooth);if(this.lastTexture===n&&i===t.type||(this.gl.bindTexture(this.gl.TEXTURE_2D,n),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=n),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(o=t.opacity)&&void 0!==o?o:1),this.gl.uniform1i(this.programManager.useTintColorUniform,t.tintColor?1:0),t.tintColor){const{r:e,g:i,b:s,a:o}=ot(t.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,e,i,s,o)}if(this.gl.uniform1i(this.programManager.useMaskColorUniform,t.maskColor?1:0),t.maskColor){const{r:e,g:i,b:s}=ot(t.maskColor);this.gl.uniform4f(this.programManager.maskColorUniform,e,i,s,null!==(r=t.opacity)&&void 0!==r?r:1),this.gl.uniform1f(this.programManager.maskColorMixUniform,null!==(a=t.maskColorMix)&&void 0!==a?a:1)}return this.gl.drawArrays(this.gl.TRIANGLES,0,6),!0}};var gt;!function(t){t[t.Center=0]="Center",t[t.RightUp=1]="RightUp",t[t.RightDown=2]="RightDown",t[t.RightCenter=3]="RightCenter"}(gt||(gt={}));let ut=class{constructor(t,e,i,s){this.gl=t,this.programManager=e,this.textureManager=i,this.fontAtlasFactory=s,this.type=nt.Text,this.posVertices=[],this.texVertices=[],this.lastTexture=null,this.textSize=new n,this.modelPosition=new n,this.projectionMatrix=J(),this.modelMatrix=J(),this.textureMatrix=J()}render(t,e,i){var s;if(!t.text)return!1;const o=this.fontAtlasFactory.getOrCreate(t.bitmap.charRanges,t.font,t.bitmap.fontSize);this.generateTextVertices(o,t),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.posVertices),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.texVertices),this.gl.DYNAMIC_DRAW),this.modelMatrix=Z(this.modelMatrix),this.setPositionFromOrientation(t),tt(this.modelMatrix,this.modelMatrix,[this.modelPosition.x,this.modelPosition.y,0]),it(this.modelMatrix,this.modelMatrix,null!==(s=t.rotation)&&void 0!==s?s:0),et(this.modelMatrix,this.modelMatrix,[t.fontSize,t.fontSize,1]),this.textureMatrix=Z(this.textureMatrix),st(this.projectionMatrix,this.gl,e.zoom,e.position),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),t.opacity<1?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND);const r=this.textureManager.getOrCreateTextureFromCanvas("FontFamily:"+o.fontFaceFamily,o.canvas,t.smooth);this.lastTexture===r&&i===nt.Text||(this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=r),this.gl.uniform1i(this.programManager.useTintColorUniform,0),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,t.opacity);const{r:a,g:n,b:h,a:l}=ot(t.color);return this.gl.uniform4f(this.programManager.maskColorUniform,a,n,h,l),this.gl.uniform1f(this.programManager.maskColorMixUniform,1),this.gl.uniform1i(this.programManager.useMaskColorUniform,1),this.gl.drawArrays(this.gl.TRIANGLES,0,this.posVertices.length/2),!0}generateTextVertices(t,{text:e,fontSize:i,bitmap:s,letterSpacing:o,lineSeparation:r}){this.posVertices=[],this.texVertices=[];let a=0,n=0,h=0;o/=i,r/=i;for(let i=0;i<e.length;i++){const l=e[i];if("\n"===l){h=Math.max(h,a),a=0,n-=1+r;continue}const c=t.glyphs.get(l);if(c){const e=c.width/t.bitmapFontSize;this.posVertices.push(a,n-1,a+e,n-1,a,n,a,n,a+e,n-1,a+e,n);const i=c.id%t.gridSize*t.bitmapFontSize,r=(c.id/t.gridSize|0)*t.bitmapFontSize,h=(i+s.margin.x)/t.canvas.width,l=(r+s.margin.y)/t.canvas.width,d=(i+c.width+s.spacing.x)/t.canvas.width,m=(r+t.bitmapFontSize+s.spacing.y)/t.canvas.width;this.texVertices.push(h,m,d,m,h,l,h,l,d,m,d,l),a+=e+o}}this.textSize.set(Math.max(h,a)*i,Math.abs(n-1)*i)}setPositionFromOrientation(t){this.modelPosition.set(t.position.x+(t.orientation===gt.Center?-this.textSize.x/2:0),t.position.y+(t.orientation===gt.Center||t.orientation===gt.RightCenter?this.textSize.y/2:t.orientation===gt.RightUp?this.textSize.y:0))}};var pt;!function(t){t[t.Center=0]="Center",t[t.RightUp=1]="RightUp",t[t.RightDown=2]="RightDown",t[t.RightCenter=3]="RightCenter"}(pt||(pt={}));let yt=class{constructor(t,e,i){this.gl=t,this.programManager=e,this.textureManager=i,this.posVertices=[],this.texVertices=[],this.lastTexture=null,this.tileset={width:0,tileWidth:0,tileHeight:0,texMargin:new n,texSpacing:new n,texWidth:0,texHeight:0,texCorrection:new n},this.projectionMatrix=J(),this.modelMatrix=J(),this.textureMatrix=J()}render(t,e,i){var s,o,r,a;if(0===t.tiles.reduce(((t,e)=>t+e),0))return!1;if(this.processTileset(t),this.generateVertices(t),0===this.posVertices.length)return!1;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.posVertices),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.texVertices),this.gl.DYNAMIC_DRAW),this.modelMatrix=Z(this.modelMatrix),tt(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),it(this.modelMatrix,this.modelMatrix,null!==(s=t.rotation)&&void 0!==s?s:0),et(this.modelMatrix,this.modelMatrix,[t.tilemap.tileWidth*(t.flipHorizontal?-1:1),t.tilemap.tileHeight*(t.flipVertical?-1:1),1]),this.textureMatrix=Z(this.textureMatrix),et(this.textureMatrix,this.textureMatrix,[this.tileset.tileWidth/t.tileset.image.naturalWidth,this.tileset.tileHeight/t.tileset.image.naturalHeight,1]),st(this.projectionMatrix,this.gl,e.zoom,e.position),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const n=this.textureManager.getOrCreateTextureFromImage(t.tileset.image,t.smooth);if(this.lastTexture===n&&i===nt.Tilemap||(this.gl.bindTexture(this.gl.TEXTURE_2D,n),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=n),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(o=t.opacity)&&void 0!==o?o:1),this.gl.uniform1i(this.programManager.useTintColorUniform,t.tintColor?1:0),t.tintColor){const{r:e,g:i,b:s,a:o}=ot(t.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,e,i,s,o)}if(this.gl.uniform1i(this.programManager.useMaskColorUniform,t.maskColor?1:0),t.maskColor){const{r:e,g:i,b:s}=ot(t.maskColor);this.gl.uniform4f(this.programManager.maskColorUniform,e,i,s,null!==(r=t.opacity)&&void 0!==r?r:1),this.gl.uniform1f(this.programManager.maskColorMixUniform,null!==(a=t.maskColorMix)&&void 0!==a?a:1)}return this.gl.drawArrays(this.gl.TRIANGLES,0,this.posVertices.length/2),!0}processTileset({tileset:t}){var e,i,s,o,r,a,h;t.margin=null!==(e=t.margin)&&void 0!==e?e:new n,t.spacing=null!==(i=t.spacing)&&void 0!==i?i:new n,t.correction=null!==(s=t.correction)&&void 0!==s?s:new n,this.tileset.width=t.width,this.tileset.tileWidth=t.tileWidth+(null!==(o=t.margin.x)&&void 0!==o?o:0)+(null!==(r=t.spacing.x)&&void 0!==r?r:0),this.tileset.tileHeight=t.tileHeight+(null!==(a=t.margin.y)&&void 0!==a?a:0)+(null!==(h=t.spacing.y)&&void 0!==h?h:0),this.tileset.texMargin.set(t.margin.x/this.tileset.tileWidth,t.margin.y/this.tileset.tileHeight),this.tileset.texSpacing.set(t.spacing.x/this.tileset.tileWidth,t.spacing.y/this.tileset.tileHeight),this.tileset.texCorrection.set(t.correction.x/this.tileset.tileWidth,t.correction.y/this.tileset.tileHeight),this.tileset.texWidth=1-this.tileset.texMargin.x-this.tileset.texSpacing.x-2*this.tileset.texCorrection.x,this.tileset.texHeight=1-this.tileset.texMargin.y-this.tileset.texSpacing.y-2*this.tileset.texCorrection.y}generateVertices({tiles:t,tilemap:e}){this.posVertices=[],this.texVertices=[];const i=Math.floor(t.length/e.width);t.forEach(((t,s)=>{if(0===t)return;const o=s%e.width-e.width/2,r=i/2-Math.floor(s/e.width);this.posVertices.push(o,r-1,o+1,r-1,o,r,o,r,o+1,r-1,o+1,r);const a=(t-1)%this.tileset.width+this.tileset.texMargin.x+this.tileset.texCorrection.x,n=Math.floor((t-1)/this.tileset.width)+this.tileset.texMargin.y+this.tileset.texCorrection.y;this.texVertices.push(a,n+this.tileset.texHeight,a+this.tileset.texWidth,n+this.tileset.texHeight,a,n,a,n,a+this.tileset.texWidth,n+this.tileset.texHeight,a+this.tileset.texWidth,n)}))}},ft=class{constructor(t,e,i){this.gl=t,this.programManager=e,this.textureManager=i,this.lastTexture=null,this.projectionMatrix=J(),this.modelMatrix=J(),this.textureMatrix=J(),this.posVertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.texVertices=new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0])}render(t,e,i){var s,o,r,a;i!==t.type&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.posVertices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.texVertices,this.gl.STATIC_DRAW)),this.modelMatrix=Z(this.modelMatrix),tt(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),it(this.modelMatrix,this.modelMatrix,null!==(s=t.rotation)&&void 0!==s?s:0),et(this.modelMatrix,this.modelMatrix,[t.width*(t.flipHorizontal?-1:1),t.height*(t.flipVertical?-1:1),1]),this.textureMatrix=Z(this.textureMatrix),t.slice&&(tt(this.textureMatrix,this.textureMatrix,[t.slice.x/t.video.videoWidth,t.slice.y/t.video.videoHeight,0]),et(this.textureMatrix,this.textureMatrix,[t.slice.width/t.video.videoWidth,t.slice.height/t.video.videoHeight,1])),st(this.projectionMatrix,this.gl,e.zoom,e.position),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const n=this.textureManager.getOrCreateTextureFromVideo(t.video);if(this.lastTexture===n&&i===t.type||(this.gl.bindTexture(this.gl.TEXTURE_2D,n),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=n),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.video),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(o=t.opacity)&&void 0!==o?o:1),this.gl.uniform1i(this.programManager.useTintColorUniform,t.tintColor?1:0),t.tintColor){const{r:e,g:i,b:s,a:o}=ot(t.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,e,i,s,o)}if(this.gl.uniform1i(this.programManager.useMaskColorUniform,t.maskColor?1:0),t.maskColor){const{r:e,g:i,b:s}=ot(t.maskColor);this.gl.uniform4f(this.programManager.maskColorUniform,e,i,s,null!==(r=t.opacity)&&void 0!==r?r:1),this.gl.uniform1f(this.programManager.maskColorMixUniform,null!==(a=t.maskColorMix)&&void 0!==a?a:1)}return this.gl.drawArrays(this.gl.TRIANGLES,0,6),!0}};class xt{constructor(t){this.gl=t}createFromImage(t,e=!0,i=null){return i=null!=i?i:this.gl.createTexture(),t.naturalWidth?this.createFromSource(t,i,e):t.addEventListener("load",(()=>this.createFromSource(t,i,e))),i}createFromCanvas(t,e=!0,i=null){return i=null!=i?i:this.gl.createTexture(),this.createFromSource(t,i,e),i}createPixelTexture(){const t=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array([0,0,0,255])),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t}createFromSource(t,e,i=!0){this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),!1===i?(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST)):(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR)),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}}class Mt{constructor(t){this.textureFactory=t,this.textures=new Map}getOrCreateTextureFromImage(t,e=!0){var i;return null!==(i=this.textures.get(Symbol.for(t.src)))&&void 0!==i?i:this.createTextureFromImage(t,e)}createTextureFromImage(t,e=!0){const i=this.textureFactory.createFromImage(t,e);return this.textures.set(Symbol.for(t.src),i),i}getOrCreateTextureFromCanvas(t,e,i=!0){var s;return null!==(s=this.textures.get(Symbol.for(t)))&&void 0!==s?s:this.createTextureFromCanvas(t,e,i)}createTextureFromCanvas(t,e,i=!0){const s=this.textureFactory.createFromCanvas(e,i);return this.textures.set(Symbol.for(t),s),s}getOrCreateTextureFromVideo(t){var e;return null!==(e=this.textures.get(Symbol.for(t.src)))&&void 0!==e?e:this.createTextureFromVideo(t)}createTextureFromVideo(t){const e=this.textureFactory.createPixelTexture();return this.textures.set(Symbol.for(t.src),e),e}}let vt=class{constructor(t){this.renderers=new Map;const e=new H(t),i=e.gl,s=e.contextVersion,o=new K(i,s,new $(i,new q(i))),r=new Mt(new xt(i)),a=new Y;this.renderers.set(nt.Sprite,new mt(i,o,r)),this.renderers.set(nt.Text,new ut(i,o,r,a)),this.renderers.set(nt.Tilemap,new yt(i,o,r)),this.renderers.set(nt.Geometric,new lt(i,o)),this.renderers.set(nt.Mask,new ct(i,o)),this.renderers.set(nt.Video,new ft(i,o,r)),this.renderers.set(nt.Shadow,new dt(i,o)),this.canvasColorRenderer=new rt(i),o.loadProgram()}render(t,e){this.renderers.get(t.type).render(t,e,this.lastRender)&&(this.lastRender=t.type)}renderCanvasColor(t){this.canvasColorRenderer.render(t)}};vt=r([i(t.WebGLManager),a(0,s(t.CanvasElement))],vt);class St{constructor(t){this.offset=new n,this.rotation=0,this.layer=W,this.loop=!1,this.volume=1,this.play=!1,this.pause=!1,this._renderData={type:nt.Video,height:void 0,layer:void 0,position:new n,video:void 0,width:void 0,flipHorizontal:void 0,flipVertical:void 0,maskColor:void 0,maskColorMix:void 0,opacity:void 0,rotation:void 0,slice:void 0,tintColor:void 0},Object.assign(this,t)}}const Ct=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","pointerup","touchend","keydown","keyup"];let bt=class{constructor(t,e,i){this.entityManager=t,this.renderManager=e,this.timeManager=i,this.scaledOffset=new n,this.userInputEventHandler=()=>{Ct.forEach((t=>{window.removeEventListener(t,this.userInputEventHandler)})),this.canPlay=!0}}onCreate(){this.canPlay=!1,Ct.forEach((t=>window.addEventListener(t,this.userInputEventHandler)))}onUpdate(){this.entityManager.search(St).forEach((({entity:t,component:e})=>{var i,s;const o=this.entityManager.getComponent(t,G);if(!o)throw new Error("VideoRenderer component needs a Transform");e.video&&e.video.duration&&(this.checkVideoState(e),this.scaledOffset.set(e.offset.x*o.localScale.x,e.offset.y*o.localScale.y),n.add(e._renderData.position,o.localPosition,this.scaledOffset),e._renderData.layer=e.layer,e._renderData.video=e.video,e._renderData.width=(null!==(i=e.width)&&void 0!==i?i:e.video.videoWidth)*Math.abs(o.localScale.x),e._renderData.height=(null!==(s=e.height)&&void 0!==s?s:e.video.videoHeight)*Math.abs(o.localScale.y),e._renderData.rotation=o.localRotation+e.rotation,e._renderData.slice=e.slice,e._renderData.flipHorizontal=e.flipHorizontally,e._renderData.flipVertical=e.flipVertically,e._renderData.opacity=e.opacity,e._renderData.maskColor=e.maskColor,e._renderData.maskColorMix=e.maskColorMix,e._renderData.tintColor=e.tintColor,0!==o.localRotation&&this.scaledOffset.magnitude>0&&this.translateRenderPosition(e._renderData,o),this.renderManager.addRenderData(e._renderData))}))}translateRenderPosition(t,e){const i=Math.atan2(this.scaledOffset.y,this.scaledOffset.x)+e.localRotation;t.position.set(e.localPosition.x+this.scaledOffset.magnitude*Math.cos(i),e.localPosition.y+this.scaledOffset.magnitude*Math.sin(i))}checkVideoState(t){const{video:e,play:i,pause:s,loop:o,volume:r}=t;e.loop=o,e.volume=r,e.playbackRate=this.timeManager.timeScale<.0625?0:Math.min(this.timeManager.timeScale,16),i&&e.ended&&(t.play=!1),i&&e.paused&&this.canPlay&&e.play(),!i&&e.currentTime>0&&(e.pause(),e.currentTime=0),s&&!e.paused&&e.pause(),!s&&e.paused&&i&&this.canPlay&&e.play()}onDisable(){this.entityManager.search(St).forEach((({component:t})=>{t.video&&(t.video.pause(),t.video.currentTime=0)}))}onDestroy(){this.onDisable()}};bt=r([i(j.VideoRendererSystem),a(0,s(t.EntityManager)),a(1,s(t.RenderManager)),a(2,s(t.TimeManager))],bt);class wt{constructor(t,e){this.entityManager=t,this.assetManager=e}loadAssets(){}setup(){}}let Et=class{constructor(t,e,i,s){this.systemManager=t,this.systemFactory=e,this.entityManager=i,this.assetManager=s,this.scenes=new Map,this.loadingScene=!1}addScene(t,e,i=!1){const s=new t(this.entityManager,this.assetManager);this.scenes.set(e,s),i&&(this.openingSceneName=e)}loadScene(t){if(!this.scenes.has(t))throw new Error(`Invalid scene name: '${t}'`);this.sceneNameToBeLoaded=t}loadOpeningScene(){if(!this.openingSceneName)throw new Error("There is no opening scene");this.sceneNameToBeLoaded=this.openingSceneName}update(){this.sceneNameToBeLoaded&&(this.currentSceneName&&this.destroyCurrentScene(),this.currentSceneName=this.sceneNameToBeLoaded,this.sceneNameToBeLoaded=void 0,this.scenes.get(this.currentSceneName).loadAssets(),this.loadingScene=!0),this.loadingScene&&this.assetManager.getAssetsLoaded()&&(this.loadingScene=!1,this.scenes.get(this.currentSceneName).setup(),this.systemManager.update(V.PostGameLogic),this.scenes.get(this.currentSceneName).systems.forEach(((t,e)=>{this.systemFactory.createSystemIfNotExists(t),this.systemManager.enableSystem(t),this.systemManager.setExecutionOrder(t,e)})))}destroyCurrentScene(){this.systemManager.disableSystem(O),this.systemManager.disableSystem(bt),this.entityManager.removeAllEntities(),this.scenes.get(this.currentSceneName).systems.forEach((t=>this.systemManager.disableSystem(t))),this.systemManager.enableSystem(O),this.systemManager.enableSystem(bt)}};Et=r([i(t.SceneManager),a(0,s(t.SystemManager)),a(1,s(t.SystemFactory)),a(2,s(t.EntityManager)),a(3,s(t.AssetManager))],Et);class _t{constructor(t){this.width=0,this.height=0,this.radius=0,this.touchEnabled=!0,this.offset=new n,this.pressed=!1,Object.assign(this,t)}}var Rt;!function(t){t[t.Rectangle=0]="Rectangle",t[t.Circumference=1]="Circumference"}(Rt||(Rt={}));let At=class{constructor(t,e){this.entityManager=t,this.scaled={position:new n,width:0,height:0,radius:0},this.distance=new n,this.pressedLastFrame=!1,this.mouse=e.mouse,this.touchScreen=e.touchScreen}onUpdate(){this.entityManager.search(_t).forEach((({entity:t,component:e})=>{const i=this.entityManager.getComponent(t,G);if(!i)throw new Error("Button component needs a Transform");this.pressedLastFrame=e.pressed,e.pressed=!1,this.scale(e,i),this.mouse.leftButtonPressed&&(this.resolveMouseAndRectangle(e),this.resolveMouseAndCircumference(e)),e.touchEnabled&&this.touchScreen.touching&&(this.resolveTouchAndRectangle(e),this.resolveTouchAndCircumference(e)),e.onClick&&!this.pressedLastFrame&&e.pressed&&e.onClick(),e.onPressed&&e.pressed&&e.onPressed()}))}scale(t,{localPosition:e,localScale:i}){this.scaled.width=t.width*i.x,this.scaled.height=t.width*i.y,this.scaled.position.x=e.x+t.offset.x*i.x,this.scaled.position.y=e.y+t.offset.y*i.y,this.scaled.radius=t.radius*Math.max(Math.abs(i.x),Math.abs(i.y))}resolveMouseAndRectangle(t){t.shape===Rt.Rectangle&&(t.pressed=c(this.mouse.positionInViewport.x,this.scaled.position.x-this.scaled.width/2,this.scaled.position.x+this.scaled.width/2)&&c(this.mouse.positionInViewport.y,this.scaled.position.y-this.scaled.height/2,this.scaled.position.y+this.scaled.height/2))}resolveMouseAndCircumference(t){t.shape===Rt.Circumference&&(n.subtract(this.distance,this.scaled.position,this.mouse.positionInViewport),t.pressed=this.distance.magnitude<=this.scaled.radius)}resolveTouchAndRectangle(t){if(t.shape===Rt.Rectangle)for(const{positionInViewport:e,radius:i}of this.touchScreen.interactions){if(t.pressed)return;t.pressed=this.scaled.position.x+this.scaled.width/2>=e.x-i.x&&this.scaled.position.x-this.scaled.width/2<=e.x+i.x&&this.scaled.position.y+this.scaled.height/2>=e.y-i.y&&this.scaled.position.y-this.scaled.height/2<=e.y+i.y}}resolveTouchAndCircumference(t){if(t.shape===Rt.Circumference)for(const{positionInViewport:e,radius:i}of this.touchScreen.interactions){if(t.pressed)return;n.subtract(this.distance,this.scaled.position,e),t.pressed=this.distance.magnitude<=this.scaled.radius+Math.max(i.x,i.y)}}};At=r([i(j.ButtonSystem),a(0,s(t.EntityManager)),a(1,s(t.InputManager))],At);class Tt{constructor(){this.entities=[]}}let Dt=class{constructor(t){this.entityManager=t}onUpdate(){this.entityManager.search(Tt).forEach((({entity:t,component:e})=>{e.entities=this.entityManager.getComponent(t,G)._childEntities}))}};Dt=r([i(j.ChildrenSystem),a(0,s(t.EntityManager))],Dt);class Bt{}let Pt=class{constructor(t){this.entityManager=t}onUpdate(){this.entityManager.search(Bt).forEach((({entity:t,component:e})=>{e.entity=this.entityManager.getComponent(t,G)._parentEntity}))}};Pt=r([i(j.ParentSystem),a(0,s(t.EntityManager))],Pt);class Ut{constructor(t){Object.assign(this,t)}}class Ft{constructor(t){this.layer=W,this.tileset=void 0,this.data=[],this.chunks=[],this.width=0,this.height=0,this.tileWidth=void 0,this.tileHeight=void 0,this.tintColor=void 0,this.opacity=1,this.smooth=!1,this._processed=!1,this._renderData=[],Object.assign(this,t)}}let Lt=class{constructor(t){this.entityManager=t}onUpdate(){this.entityManager.search(Ut).forEach((({entity:t,component:e})=>{const i=this.entityManager.getComponent(t,Ft);if(!i)return;const s=e.tilemap.layers.find((t=>t.name===e.layerToRender&&"tilelayer"===t.type));s&&(e.tilemap.infinite?i.chunks=s.chunks:i.data=s.data,i.width=e.tilemap.width)}))}};Lt=r([i(j.TiledWrapperSystem),a(0,s(t.EntityManager))],Lt);const It=16;let jt=class{constructor(t){this.entityManager=t}onUpdate(){this.entityManager.search(Ft).forEach((({component:t})=>{var e,i;t._processed||(t.chunks&&t.chunks.length>0?this.chunksToData(t):t.data&&t.data.length>0&&this.dataToChunks(t),t.tileWidth=null!==(e=t.tileWidth)&&void 0!==e?e:t.tileset.tileWidth,t.tileHeight=null!==(i=t.tileHeight)&&void 0!==i?i:t.tileset.tileHeight,t._processed=!0)}))}dataToChunks(t){t.height=Math.ceil(t.data.length/t.width);const e=Math.ceil(t.width/It),i=Math.ceil(t.height/It);for(let s=0;s<i;s++)for(let i=0;i<e;i++){const e={x:i*It,y:s*It,width:It,height:It,data:[]};for(let i=0;i<e.width*e.height;i++){const s=e.x+i%e.width,o=t.width*(e.y+Math.floor(i/e.width));e.data[i]=s<t.width&&o<t.height*t.width?t.data[o+s]:0}t.chunks.push(e)}}chunksToData(t){t.data=[],t.chunks.forEach((e=>e.data.forEach(((i,s)=>{t.data[t.width*(e.y+Math.floor(s/e.width))+e.x+s%e.width]=i})))),t.height=Math.ceil(t.data.length/t.width)}};jt=r([i(j.TilemapPreProcessingSystem),a(0,s(t.EntityManager))],jt);const kt=t=>t.parent?1+kt(t.parent):0;let Ot=class{constructor(t){this.entityManager=t}onUpdate(){this.entityManager.search(G).sort(((t,e)=>kt(t.component)-kt(e.component))).forEach((({component:t,entity:e})=>{t.parent&&this.entityManager.getEntityForComponent(t.parent)?(t._childEntities=[],t._parentEntity=this.entityManager.getEntityForComponent(t.parent),t.parent._childEntities.push(e),this.translateChild(t.parent,t)):this.updateTransform(t)}))}updateTransform(t){t.parent=void 0,t._parentEntity=void 0,t._childEntities=[],t.localPosition.copy(t.position),t.localScale.copy(t.scale),t.localRotation=t.rotation}translateChild(t,e){e.localRotation=e.rotation+t.localRotation,e.localScale.x=e.scale.x*t.scale.x,e.localScale.y=e.scale.y*t.scale.y;const i=Math.atan2(e.position.y,e.position.x)+t.localRotation;e.localPosition.set(t.localPosition.x+e.position.magnitude*Math.cos(i),t.localPosition.y+e.position.magnitude*Math.sin(i))}};Ot=r([i(j.TransformSystem),a(0,s(t.EntityManager))],Ot);let Vt=class{constructor(t){this.inputManager=t,this.gamepads=new Map,this.eventHandler=t=>{"gamepadconnected"===t.type?this.gamepadConnected(t.gamepad):"gamepaddisconnected"===t.type&&this.gamepadDisconected(t.gamepad)},window.addEventListener("gamepadconnected",this.eventHandler),window.addEventListener("gamepaddisconnected",this.eventHandler)}gamepadConnected(t){this.gamepads.set(t.index,t),this.inputManager.gamepads[t.index]||(this.inputManager.gamepads[t.index]=new R,this.inputManager.gamepads[t.index].index=t.index),this.inputManager.gamepads[t.index].id=t.id,this.inputManager.gamepads[t.index].connected=!0}gamepadDisconected(t){this.gamepads.delete(t.index),this.inputManager.gamepads[t.index].connected=!1}onUpdate(){for(const t of this.getGamepadsFromBrowser())t&&(!1===this.gamepads.has(t.index)?this.gamepadConnected(t):this.gamepads.set(t.index,t));this.gamepads.forEach((t=>{const e=this.inputManager.gamepads[t.index];t.buttons.forEach(((t,i)=>e.buttons.set(i,t.pressed))),t.axes.forEach(((t,i)=>e.axes.set(i,t))),e.vibrationInput&&(t.vibrationActuator.playEffect(t.vibrationActuator.type,{duration:e.vibrationInput.duration,weakMagnitude:e.vibrationInput.weakMagnitude,strongMagnitude:e.vibrationInput.strongMagnitude,startDelay:e.vibrationInput.startDelay}).catch((()=>e.vibrating=!1)).finally((()=>e.vibrating=!1)),e.vibrating=!0,e.vibrationInput=void 0)}))}getGamepadsFromBrowser(){return navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[]}};Vt=r([i(j.GamepadSystem),a(0,s(t.InputManager))],Vt);let Gt=class{constructor(t,{keyboard:e}){this.pressedKeys=[],this.eventHandler=t=>{"keydown"!==t.type||this.pressedKeys.includes(t.code)||this.pressedKeys.push(t.code),"keyup"===t.type&&this.pressedKeys.includes(t.code)&&this.pressedKeys.splice(this.pressedKeys.indexOf(t.code),1)},this.keyboard=e,t.addEventListener("keydown",this.eventHandler),t.addEventListener("keyup",this.eventHandler),t.addEventListener("focusout",(()=>this.pressedKeys=[]))}onUpdate(){this.keyboard.pressedKeys=[...this.pressedKeys]}};Gt=r([i(j.KeyboardSystem),a(0,s(t.CanvasElement)),a(1,s(t.InputManager))],Gt);let Wt=class{constructor(t,{mouse:e}){this.canvas=t,this.leftButtonPressed=!1,this.scrollButtonPressed=!1,this.rightButtonPressed=!1,this.positionInViewport=new n,this.lastPositionInViewport=new n,this.mouse=e,this.canvas.addEventListener("mousemove",(t=>this.updatePosition(t))),this.canvas.addEventListener("mousedown",(t=>this.updateButtonDown(t))),this.canvas.addEventListener("mouseup",(t=>this.updateButtonUp(t))),this.canvas.addEventListener("wheel",(t=>this.handleWheelEvent(t))),this.canvas.addEventListener("focusout",(()=>this.onFocusOut()))}updateButtonDown(t){this.canvas.focus(),t.preventDefault(),t.stopPropagation(),this.leftButtonPressed=0===t.button,this.scrollButtonPressed=1===t.button,this.rightButtonPressed=2===t.button}updateButtonUp(t){t.preventDefault(),t.stopPropagation(),this.leftButtonPressed=0!==t.button&&this.leftButtonPressed,this.scrollButtonPressed=1!==t.button&&this.scrollButtonPressed,this.rightButtonPressed=2!==t.button&&this.rightButtonPressed}updatePosition(t){t.preventDefault(),t.stopPropagation(),this.positionInViewport.set(t.offsetX/(this.canvas.clientWidth/this.canvas.width)-this.canvas.width/2,-t.offsetY/(this.canvas.clientHeight/this.canvas.height)+this.canvas.height/2)}handleWheelEvent(t){t.preventDefault(),t.stopPropagation(),this.wheelEvent=t}onFocusOut(){this.leftButtonPressed=!1,this.scrollButtonPressed=!1,this.rightButtonPressed=!1}onUpdate(){this.mouse.leftButtonPressed=this.leftButtonPressed,this.mouse.rightButtonPressed=this.rightButtonPressed,this.mouse.scrollButtonPressed=this.scrollButtonPressed,this.mouse.positionInViewport.copy(this.positionInViewport),this.positionInViewport.equals(this.lastPositionInViewport)?this.mouse.hasMoved=!1:(this.mouse.hasMoved=!0,this.lastPositionInViewport.copy(this.positionInViewport)),this.wheelEvent?(this.mouse.wheelScroll.set(this.wheelEvent.deltaX,this.wheelEvent.deltaY),this.wheelEvent=void 0):this.mouse.wheelScroll.set(0,0)}};Wt=r([i(j.MouseSystem),a(0,s(t.CanvasElement)),a(1,s(t.InputManager))],Wt);let Nt=class{constructor(t,{touchScreen:e}){this.canvas=t,this.touching=!1,this.interactions=[],this.eventHandler=t=>{"touchstart"===t.type&&(this.touching=!0,this.updatePosition(t)),"touchmove"===t.type&&this.updatePosition(t),"touchend"!==t.type&&"touchcancel"!==t.type||(this.touching=!1)},this.touchScreen=e,this.canvas.addEventListener("touchstart",this.eventHandler),this.canvas.addEventListener("touchend",this.eventHandler),this.canvas.addEventListener("touchcancel",this.eventHandler),this.canvas.addEventListener("touchmove",this.eventHandler)}updatePosition(t){if(t.preventDefault(),t.stopPropagation(),this.interactions=[],0!==t.targetTouches.length)for(let e=0;e<t.targetTouches.length;e++)this.interactions[e]={positionInViewport:new n((t.targetTouches[e].clientX-this.canvas.offsetLeft)/(this.canvas.clientWidth/this.canvas.width)-this.canvas.width/2,-(t.targetTouches[e].clientY-this.canvas.offsetTop)/(this.canvas.clientHeight/this.canvas.height)+this.canvas.height/2),radius:new n(t.targetTouches[e].radiusX,t.targetTouches[e].radiusY)}}onUpdate(){this.touchScreen.touching=this.touching,this.touchScreen.interactions=[...this.touchScreen.interactions]}};Nt=r([i(j.TouchScreenSystem),a(0,s(t.CanvasElement)),a(1,s(t.InputManager))],Nt);class zt{constructor(t){this.animations=new Map,this.speed=1,this.reset=!1,this.playing=!1,this.currentFrame=0,this.currentTime=0,this._currentAnimation=void 0,Object.assign(this,t)}}class Ht{constructor(t){this.layer=W,this.smooth=!1,this.offset=new n,this.flipHorizontally=!1,this.flipVertically=!1,this.rotation=0,this.opacity=1,this.scale=new n(1,1),this._renderData={type:nt.Sprite,position:new n,layer:void 0,image:void 0,width:void 0,height:void 0},Object.assign(this,t)}}let Yt=class{constructor(t,e){this.entityManager=t,this.timeManager=e}onUpdate(){this.entityManager.search(zt).forEach((({entity:t,component:e})=>{if(this.reset(e),this.animation=e.animations.get(e.animation),!this.animation)return;this.play(e),e._currentAnimation=e.animation;const i=this.entityManager.getComponent(t,Ht);i&&this.renderSprite(e,i)}))}reset(t){t.reset&&(t.currentFrame=0,t.currentTime=0,t.playing=void 0!==t.animation,t.reset=!1)}play(t){t.animation!==t._currentAnimation&&(t._currentAnimation=t.animation,t.currentFrame=0,t.currentTime=0,t.playing=!0),t.playing&&(t.currentTime>=1/this.animation.fps*(t.currentFrame+1)&&(t.currentFrame===this.animation.frames.length-1?this.animation.loop?(t.currentFrame=0,t.currentTime=0):t.playing=!1:t.currentFrame++),t.currentTime+=this.timeManager.renderDeltaTime*t.speed)}renderSprite(t,e){if(Array.isArray(this.animation.image))e.image=this.animation.image[t.currentFrame];else{const i=this.animation.frames[t.currentFrame],s=Math.floor(this.animation.image.naturalWidth/this.animation.slice.size.x);e.image=this.animation.image,e.slice={x:i%s*this.animation.slice.size.x+this.animation.slice.offset.x,y:Math.floor(i/s)*this.animation.slice.size.y+this.animation.slice.offset.y,width:this.animation.slice.size.x-this.animation.slice.padding.y,height:this.animation.slice.size.y-this.animation.slice.padding.y}}}};Yt=r([i(j.AnimatorSystem),a(0,s(t.EntityManager)),a(1,s(t.TimeManager))],Yt);let Xt=class{constructor(t,e){this.entityManager=t,this.renderManager=e}onUpdate(){this.entityManager.search(N).forEach((({entity:t,component:e})=>{const i=this.entityManager.getComponent(t,G);if(!i)throw new Error("Camera component needs a Transform");e._renderData.position.copy(i.localPosition),e._renderData.layers=e.layers,e._renderData.depth=e.depth,e._renderData.zoom=e.zoom,this.renderManager.addCameraData(e._renderData)}))}};Xt=r([i(j.CameraSystem),a(0,s(t.EntityManager)),a(1,s(t.RenderManager))],Xt);let $t=class{constructor(t,e){this.webGLManager=t,this.gameConfig=e}onUpdate(){this.webGLManager.renderCanvasColor(this.gameConfig.canvasColor)}};$t=r([i(j.ClearScreenSystem),a(0,s(t.WebGLManager)),a(1,s(t.GameConfig))],$t);class Kt{constructor(t){this.radius=0,this.offset=new n,this.layer="",this.physics=!0,this.ignoreCollisionsWithLayers=[],this.shapes=[],Object.assign(this,t)}}class qt{constructor(t){this.layer="",this.physics=!0,this.width=0,this.height=0,this.offset=new n,this.rotation=0,this.ignoreCollisionsWithLayers=[],this.shapes=[],Object.assign(this,t)}}class Qt{constructor(t){this.vertexModel=[],this.offset=new n,this.rotation=0,this.layer="",this.physics=!0,this.ignoreCollisionsWithLayers=[],this.shapes=[],Object.assign(this,t)}}class Jt{constructor(t){this.vertexModel=[],this.offset=new n,this.rotation=0,this.layer="",this.physics=!0,this.ignoreCollisionsWithLayers=[],this.shapes=[],Object.assign(this,t)}}class Zt{constructor(t){this.composite=!0,this.layer="",this.ignoreCollisionsWithLayers=[],this.offset=new n,this.physics=!0,this.shapes=[],Object.assign(this,t)}}let te=class{constructor(t,e,i){this.entityManager=t,this.renderManager=e,this.collisionMethod=i.collisions.collisionMethod,this.debugEnabled=i.debugEnabled}onUpdate(){this.debugEnabled&&[Kt,qt,Jt,Qt,Zt].forEach((t=>this.entityManager.search(t).forEach((({component:t})=>t.shapes.forEach((t=>{const e={type:nt.Geometric,position:new n,layer:W,color:"#00FF00",shape:void 0,radius:void 0,rotation:void 0,vertexModel:void 0};t instanceof p?this.collisionMethod===x.SAT?(e.shape=t.vertices.length>2?at.Polygon:at.Line,e.vertexModel=t.vertices):this.collisionMethod===x.AABB&&(e.shape=at.Polygon,e.vertexModel=[new n(t.boundingBox.x,t.boundingBox.y),new n(t.boundingBox.x,t.boundingBox.y1),new n(t.boundingBox.x1,t.boundingBox.y1),new n(t.boundingBox.x1,t.boundingBox.y)]):t instanceof y&&(e.shape=at.Circumference,e.position.copy(t.position),e.radius=t.radius),this.renderManager.addRenderData(e)}))))))}};te=r([i(j.ColliderRenderSystem),a(0,s(t.EntityManager)),a(1,s(t.RenderManager)),a(2,s(t.GameConfig))],te);let ee=class{constructor(t,e){this.renderManager=t,this.canvas=e,this.viewport={x:0,x1:0,y:0,y1:0},this.object={x:0,x1:0,y:0,y1:0},this.culledRenderData=[]}onUpdate(){this.culledRenderData=[],this.renderManager.getCameraData().forEach((t=>{this.setViewport(t),this.renderManager.getRenderData().filter((e=>t.layers.includes(e.layer))).forEach((t=>{this.isInViewPort(t)&&(t.type===nt.Tilemap&&this.applyCullingInTiles(t),this.culledRenderData.push(t))}))})),this.renderManager.setRenderData(this.culledRenderData)}isInViewPort(t){switch(t.type){case nt.Video:case nt.Mask:case nt.Shadow:case nt.Sprite:this.setObjectForResizeable(t);break;case nt.Geometric:this.setObjectForGeometric(t);break;case nt.Text:this.setObjectForText(t);break;case nt.Tilemap:this.setObjectForTilemap(t)}return this.viewport.x1>=this.object.x&&this.viewport.x<=this.object.x1&&this.viewport.y1>=this.object.y&&this.viewport.y<=this.object.y1}setViewport({position:t,zoom:e}){this.viewport.x=t.x-this.canvas.width/e/2,this.viewport.x1=t.x+this.canvas.width/e/2,this.viewport.y=t.y-this.canvas.height/e/2,this.viewport.y1=t.y+this.canvas.height/e/2}setObjectForResizeable({position:t,width:e,height:i,rotation:s=0}){const o=Math.abs(Math.sin(s)),r=Math.abs(Math.cos(s)),a=o*i+r*e,n=o*e+r*i;this.object.x=t.x-a/2,this.object.x1=t.x+a/2,this.object.y=t.y-n/2,this.object.y1=t.y+n/2}setObjectForText({position:t,text:e,fontSize:i,lineSeparation:s,letterSpacing:o,rotation:r}){const a=e.split("\n").reduce(((t,e)=>Math.max(t,e.length)),0)*(i+(null!=o?o:0))*2,n=e.split("\n").length*(i+(null!=s?s:0));this.setObjectForResizeable({position:t,width:a,height:n,rotation:r})}setObjectForGeometric({position:t,vertexModel:e,shape:i,radius:s}){i===at.Circumference?(this.object.x=t.x-s,this.object.y=t.y-s,this.object.x1=t.x+s,this.object.y1=t.y+s):(this.object.x=Number.MAX_SAFE_INTEGER,this.object.y=Number.MAX_SAFE_INTEGER,this.object.x1=Number.MIN_SAFE_INTEGER,this.object.y1=Number.MIN_SAFE_INTEGER,e.forEach((e=>{this.object.x=Math.min(e.x+t.x,this.object.x),this.object.y=Math.min(e.y+t.y,this.object.y),this.object.x1=Math.max(e.x+t.x,this.object.x1),this.object.y1=Math.max(e.y+t.y,this.object.y1)})))}setObjectForTilemap(t){t.tilemap.height=Math.ceil(t.tiles.length/t.tilemap.width),this.setObjectForResizeable({position:t.position,width:t.tilemap.width*t.tilemap.tileWidth,height:t.tilemap.height*t.tilemap.tileHeight,rotation:t.rotation})}applyCullingInTiles(t){const{tiles:e,tilemap:{width:i,tileWidth:s,tileHeight:o}}=t;t.tiles=e.map(((t,e)=>this.viewport.x1>=this.object.x+e%i*s&&this.viewport.x<=this.object.x+e%i*s+s&&this.viewport.y1>=this.object.y1-((e/i|0)*o+o)&&this.viewport.y<=this.object.y1-(e/i|0)*o?t:0))}};ee=r([i(j.CullingSystem),a(0,s(t.RenderManager)),a(1,s(t.CanvasElement))],ee);class ie{constructor(t){this.width=0,this.height=0,this.radius=0,this.offset=new n,this.rotation=0,this.opacity=1,this.layer=W,this._renderData={type:nt.Mask,color:void 0,height:void 0,layer:void 0,opacity:void 0,position:new n,radius:void 0,rotation:void 0,shape:void 0,width:void 0},Object.assign(this,t)}}let se=class{constructor(t,e){this.entityManager=t,this.renderManager=e,this.scaledOffset=new n}onUpdate(){this.entityManager.search(ie).forEach((({entity:t,component:e})=>{const i=this.entityManager.getComponent(t,G);if(!i)throw new Error("MaskRenderer component needs a Transform");this.scaledOffset.set(e.offset.x*i.localScale.x,e.offset.y*i.localScale.y),n.add(e._renderData.position,i.localPosition,this.scaledOffset),e._renderData.width=e.width*Math.abs(i.localScale.x),e._renderData.height=e.height*Math.abs(i.localScale.y),e._renderData.rotation=i.localRotation+e.rotation,e._renderData.color=e.color,e._renderData.layer=e.layer,e._renderData.opacity=e.opacity,e._renderData.radius=e.radius*Math.max(Math.abs(i.localScale.x),Math.abs(i.localScale.y)),e._renderData.shape=e.shape,0!==i.localRotation&&this.scaledOffset.magnitude>0&&this.translateRenderPosition(e._renderData,i),this.renderManager.addRenderData(e._renderData)}))}translateRenderPosition(t,e){const i=Math.atan2(this.scaledOffset.y,this.scaledOffset.x)+e.localRotation;t.position.set(e.localPosition.x+this.scaledOffset.magnitude*Math.cos(i),e.localPosition.y+this.scaledOffset.magnitude*Math.sin(i))}};se=r([i(j.MaskRendererSystem),a(0,s(t.EntityManager)),a(1,s(t.RenderManager))],se);let oe=class{constructor(t){this.renderManager=t}onUpdate(){this.renderManager.render(),this.renderManager.removeCameraData(),this.renderManager.removeRenderData()}};oe=r([i(j.RenderSystem),a(0,s(t.RenderManager))],oe);class re{constructor(t){this.radius=0,this.smooth=!1,this.layer="",this.intensity=1,this._boundingBox=new h,Object.assign(this,t)}}class ae{constructor(t){this.width=0,this.height=0,this.color="#000000",this.opacity=1,this.layer="",this._boundingBox=new h,this._renderData={type:nt.Shadow,layer:void 0,color:void 0,opacity:void 0,width:void 0,height:void 0,position:void 0,rotation:void 0,lights:[]},Object.assign(this,t)}}let ne=class{constructor(t,e){this.entityManager=t,this.renderManager=e}onUpdate(){const t=this.entityManager.search(re);t.forEach((({entity:t,component:e})=>this.updateLightRendererBoundingBox(t,e))),this.entityManager.search(ae).forEach((({entity:e,component:i})=>{this.updatShadowRendererBoundingBox(e,i),i._renderData.layer=i.layer,i._renderData.color=i.color,i._renderData.opacity=i.opacity,i._renderData.width=i._boundingBox.width,i._renderData.height=i._boundingBox.height,i._renderData.position=i._boundingBox.center,i._renderData.rotation=0,i._renderData.lights=[],i._renderData.lights=t.filter((({component:t})=>t.layer===i.layer&&t._boundingBox.overlaps(i._boundingBox))).map((({component:{_boundingBox:t,smooth:e,intensity:i}})=>({position:t.center,radius:t.width/2,smooth:e,intensity:i}))),this.renderManager.addRenderData(i._renderData)}))}updateLightRendererBoundingBox(t,e){const i=this.entityManager.getComponent(t,G);if(!i)throw new Error("LightRenderer component needs a Transform");const s=e.radius*Math.abs(Math.max(i.localScale.x,i.localScale.y));e._boundingBox.set(i.localPosition.x-s,i.localPosition.y-s,2*s,2*s)}updatShadowRendererBoundingBox(t,e){const i=this.entityManager.getComponent(t,G);if(!i)throw new Error("ShadowRenderer component needs a Transform");const s=e.width*Math.abs(i.localScale.x),o=e.height*Math.abs(i.localScale.y);e._boundingBox.set(i.localPosition.x-s/2,i.localPosition.y-o/2,s,o)}};ne=r([i(j.ShadowLightRendererSystem),a(0,s(t.EntityManager)),a(1,s(t.RenderManager))],ne);let he=class{constructor(t,e){this.entityManager=t,this.renderManager=e,this.scaledOffset=new n}onUpdate(){this.entityManager.search(Ht).forEach((({component:t,entity:e})=>{var i,s,o,r,a,h;const l=this.entityManager.getComponent(e,G);if(!l)throw new Error("SpriteRenderer component needs a Transform");t.image&&t.image.complete&&(this.scaledOffset.set(t.offset.x*l.localScale.x,t.offset.y*l.localScale.y),n.add(t._renderData.position,l.localPosition,this.scaledOffset),t._renderData.width=(null!==(o=null!==(i=t.width)&&void 0!==i?i:null===(s=t.slice)||void 0===s?void 0:s.width)&&void 0!==o?o:t.image.naturalWidth)*Math.abs(t.scale.x*l.localScale.x),t._renderData.height=(null!==(h=null!==(r=t.height)&&void 0!==r?r:null===(a=t.slice)||void 0===a?void 0:a.height)&&void 0!==h?h:t.image.naturalHeight)*Math.abs(t.scale.y*l.localScale.y),t._renderData.flipHorizontally=t.flipHorizontally!==l.scale.x<0,t._renderData.flipVertically=t.flipVertically!==l.scale.y<0,t._renderData.rotation=l.localRotation+t.rotation,0!==l.localRotation&&this.scaledOffset.magnitude>0&&this.translateRenderPosition(t._renderData,l),t._renderData.image=t.image,t._renderData.layer=t.layer,t._renderData.maskColor=t.maskColor,t._renderData.maskColorMix=t.maskColorMix,t._renderData.opacity=t.opacity,t._renderData.slice=t.slice,t._renderData.smooth=t.smooth,t._renderData.tintColor=t.tintColor,this.renderManager.addRenderData(t._renderData))}))}translateRenderPosition(t,e){const i=Math.atan2(this.scaledOffset.y,this.scaledOffset.x)+e.localRotation;t.position.set(e.localPosition.x+this.scaledOffset.magnitude*Math.cos(i),e.localPosition.y+this.scaledOffset.magnitude*Math.sin(i))}};he=r([i(j.SpriteRendererSystem),a(0,s(t.EntityManager)),a(1,s(t.RenderManager))],he);class le{constructor(t){this.layer=W,this.text="Hello World!",this.font="Arial",this.fontSize=16,this.width=160,this.height=16,this.offset=new n,this.color="#000000",this.lineSeparation=0,this.letterSpacing=0,this.charRanges=[32,126,161,255],this.smooth=!1,this.rotation=0,this.opacity=1,this.orientation=gt.Center,this.bitmapMargin=new n,this.bitmapSpacing=new n,this._renderData={type:nt.Text,position:new n,layer:void 0,text:void 0,color:void 0,font:void 0,fontSize:void 0,opacity:void 0,smooth:void 0,rotation:void 0,orientation:void 0,letterSpacing:void 0,lineSeparation:void 0,bitmap:{charRanges:void 0,fontSize:64,margin:void 0,spacing:void 0}},Object.assign(this,t)}}let ce=class{constructor(t,e){this.entityManager=t,this.renderManager=e,this.scaledOffset=new n}onUpdate(){this.entityManager.search(le).forEach((({entity:t,component:e})=>{const i=this.entityManager.getComponent(t,G);if(!i)throw new Error("TextRenderer component needs a Transform");0===e.text.length||e.font instanceof FontFace&&"loaded"!==e.font.status||(this.scaledOffset.set(e.offset.x*i.localScale.x,e.offset.y*i.localScale.y),n.add(e._renderData.position,i.localPosition,this.scaledOffset),e._renderData.layer=e.layer,e._renderData.font=e.font,e._renderData.fontSize=e.fontSize,e._renderData.text=this.crop(e),e._renderData.orientation=e.orientation,e._renderData.color=e.color,e._renderData.lineSeparation=e.lineSeparation,e._renderData.letterSpacing=e.letterSpacing,e._renderData.smooth=e.smooth,e._renderData.rotation=i.localRotation+e.rotation,e._renderData.opacity=e.opacity,e._renderData.bitmap.charRanges=e.charRanges,e._renderData.bitmap.margin=e.bitmapMargin,e._renderData.bitmap.spacing=e.bitmapSpacing,0!==i.localRotation&&this.scaledOffset.magnitude>0&&this.translateRenderPosition(e._renderData,i),this.renderManager.addRenderData(e._renderData))}))}translateRenderPosition(t,e){const i=Math.atan2(this.scaledOffset.y,this.scaledOffset.x)+e.localRotation;t.position.set(e.localPosition.x+this.scaledOffset.magnitude*Math.cos(i),e.localPosition.y+this.scaledOffset.magnitude*Math.sin(i))}crop({fontSize:t,height:e,text:i,letterSpacing:s,width:o,lineSeparation:r}){if(t>e)return"";const a=[];let n=0;for(const h of i.split("\n")){const i=h.split(/(\s+)/).reduce(((e,i)=>{const r=e.length-1,a=e[r]+i;return a.length*(t+s)>o?e.push(i):e[r]=a,e}),[""]);for(const s of i){if(n+=t+r,n>e)return a.join("\n");a.push(s)}}return a.join("\n")}};ce=r([i(j.TextRendererSystem),a(0,s(t.EntityManager)),a(1,s(t.RenderManager))],ce);let de=class{constructor(t,e){this.entityManager=t,this.renderManager=e}onUpdate(){this.entityManager.search(Ft).forEach((({entity:t,component:e})=>{const i=this.entityManager.getComponent(t,G);if(!i)throw new Error("TilemapRenderer component needs a Transform");e._processed&&e.tileset.image&&e.tileset.image.complete&&e.chunks.forEach(((t,s)=>{e._renderData[s]||(e._renderData[s]=me());const o=e._renderData[s];o.type=nt.Tilemap,o.orientation=pt.Center,o.position=new n,o.layer=e.layer,o.tilemap.width=t.width,o.tilemap.height=Math.ceil(e.data.length/t.width),o.tilemap.tileWidth=e.tileWidth*Math.abs(i.localScale.x),o.tilemap.tileHeight=e.tileHeight*Math.abs(i.localScale.y),o.tilemap.realWidth=o.tilemap.width*o.tilemap.tileWidth,o.tilemap.realHeight=o.tilemap.height*o.tilemap.tileHeight,o.tiles=t.data,o.tileset=e.tileset,o.opacity=e.opacity,o.rotation=i.localRotation,o.tintColor=e.tintColor,o.smooth=e.smooth,o.position.x=i.localPosition.x+(t.x-e.width/2+t.width/2)*o.tilemap.tileWidth,o.position.y=i.localPosition.y+(e.height/2-t.y-t.height/2)*o.tilemap.tileHeight,this.renderManager.addRenderData(o)}))}))}};de=r([i(j.TilemapRendererSystem),a(0,s(t.EntityManager)),a(1,s(t.RenderManager))],de);const me=()=>({type:nt.Tilemap,layer:void 0,position:new n,tilemap:{height:void 0,realHeight:void 0,realWidth:void 0,tileHeight:void 0,tileWidth:void 0,width:void 0},tiles:void 0,tileset:void 0});var ge;!function(t){t[t.Dynamic=0]="Dynamic",t[t.Static=1]="Static"}(ge||(ge={}));class ue{constructor(t){this.type=ge.Dynamic,this.velocity=new n,this.gravity=0,this.acceleration=new n,Object.assign(this,t)}}let pe=class{constructor(t,e,i){this.entityManager=t,this.timeManager=e,this.transformSystem=i,this.distance=new n}onUpdate(){this.entityManager.search(ue,{type:ge.Dynamic}).forEach((({component:t,entity:e})=>{const i=this.entityManager.getComponent(e,G);t.velocity.y-=t.gravity*this.timeManager.physicsDeltaTime,n.add(i.position,i.position,n.scale(this.distance,n.add(t.velocity,t.velocity,t.acceleration),this.timeManager.physicsDeltaTime))})),this.transformSystem.onUpdate()}};pe=r([i(j.ApplyVelocitySystem),a(0,s(t.EntityManager)),a(1,s(t.TimeManager)),a(2,s(j.TransformSystem))],pe);class ye{constructor(){this.auxMin=new n,this.auxMax=new n,this.auxScaledOffset=new n}updatePositionAndVertices(t,e,i){this.translatePosition(t,e,i),t instanceof p?(this.auxAngle=t.rotation+i.localRotation,t.vertexModel.forEach(((e,s)=>t.vertices[s].set(e.x*i.localScale.x,e.y*i.localScale.y))),t.vertices.forEach((e=>e.set(e.x*Math.cos(this.auxAngle)-e.y*Math.sin(this.auxAngle)+t.position.x,e.x*Math.sin(this.auxAngle)+e.y*Math.cos(this.auxAngle)+t.position.y)))):t instanceof y&&(t.radius*=Math.max(Math.abs(i.localScale.x),Math.abs(i.localScale.y)))}translatePosition(t,e,{localPosition:i,localScale:s,localRotation:o}){if(this.auxScaledOffset.set(e.x*s.x,e.y*s.y),0!==o){const e=Math.atan2(this.auxScaledOffset.y,this.auxScaledOffset.x)+o;t.position.set(i.x+this.auxScaledOffset.magnitude*Math.cos(e),i.y+this.auxScaledOffset.magnitude*Math.sin(e))}else n.add(t.position,i,this.auxScaledOffset)}updateBoundingBox(t){t instanceof y?this.updateCircumferenceBoundingBox(t):t instanceof p&&this.updatePolygonBoundingBox(t)}updateCircumferenceBoundingBox(t){t.boundingBox.set(t.position.x-t.radius,t.position.y-t.radius,2*t.radius,2*t.radius)}updatePolygonBoundingBox(t){this.auxMin.x=t.vertices[0].x,this.auxMin.y=t.vertices[0].y,this.auxMax.x=t.vertices[0].x,this.auxMax.y=t.vertices[0].y,t.vertices.forEach((t=>{this.auxMin.x=Math.min(t.x,this.auxMin.x),this.auxMin.y=Math.min(t.y,this.auxMin.y),this.auxMax.x=Math.max(t.x,this.auxMax.x),this.auxMax.y=Math.max(t.y,this.auxMax.y)})),t.boundingBox.set(this.auxMin.x,this.auxMin.y,this.auxMax.x-this.auxMin.x,this.auxMax.y-this.auxMin.y)}updateProjectionAxes(t){var e;if(t.vertices.length>2)for(let i=0;i<t.vertices.length;i++)n.normal(t.projectionAxes[i],n.subtract(t.projectionAxes[i],null!==(e=t.vertices[i+1])&&void 0!==e?e:t.vertices[0],t.vertices[i]));else n.normal(t.projectionAxes[0],n.subtract(t.projectionAxes[0],t.vertices[1],t.vertices[0]))}}let fe=class extends ye{constructor(t){super(),this.entityManager=t}onUpdate(){this.entityManager.search(Kt).forEach((({component:t,entity:e})=>{0===t.shapes.length&&(t.shapes[0]=new y(t.radius)),t.shapes[0].radius=t.radius,this.updatePositionAndVertices(t.shapes[0],t.offset,this.entityManager.getComponent(e,G)),this.updateBoundingBox(t.shapes[0]),this.updateProjectionAxes(t.shapes[0])}))}};fe=r([i(j.UpdateBallColliderShapeSystem),a(0,s(t.EntityManager))],fe);let xe=class extends ye{constructor(t){super(),this.entityManager=t}onUpdate(){this.entityManager.search(qt).forEach((({component:t,entity:e})=>{0===t.shapes.length&&(t.shapes[0]=new p([new n,new n,new n,new n])),t.shapes[0].rotation=t.rotation,t.shapes[0].vertexModel[0].set(-t.width/2,-t.height/2),t.shapes[0].vertexModel[1].set(-t.width/2,t.height/2),t.shapes[0].vertexModel[2].set(t.width/2,t.height/2),t.shapes[0].vertexModel[3].set(t.width/2,-t.height/2),this.updatePositionAndVertices(t.shapes[0],t.offset,this.entityManager.getComponent(e,G)),this.updateBoundingBox(t.shapes[0]),this.updateProjectionAxes(t.shapes[0])}))}};xe=r([i(j.UpdateBoxColliderShapeSystem),a(0,s(t.EntityManager))],xe);let Me=class extends ye{constructor(t){super(),this.entityManager=t}onUpdate(){this.entityManager.search(Qt).forEach((({component:t,entity:e})=>{for(let i=0;i<t.vertexModel.length-1;i++)t.shapes[i]||(t.shapes[i]=new p([new n,new n])),t.shapes[i].rotation=t.rotation,t.shapes[i].vertexModel=[t.vertexModel[i],t.vertexModel[i+1]],this.updatePositionAndVertices(t.shapes[i],t.offset,this.entityManager.getComponent(e,G)),this.updateBoundingBox(t.shapes[i]),this.updateProjectionAxes(t.shapes[i])}))}};Me=r([i(j.UpdateEdgeColliderShapeSystem),a(0,s(t.EntityManager))],Me);let ve=class extends ye{constructor(t){super(),this.entityManager=t}onUpdate(){this.entityManager.search(Jt).forEach((({component:t,entity:e})=>{0===t.shapes.length&&(t.shapes[0]=new p([])),t.shapes[0].rotation=t.rotation,t.shapes[0].vertexModel=t.vertexModel,this.updatePositionAndVertices(t.shapes[0],t.offset,this.entityManager.getComponent(e,G)),this.updateBoundingBox(t.shapes[0]),this.updateProjectionAxes(t.shapes[0])}))}};ve=r([i(j.UpdatePolygonColliderShapeSystem),a(0,s(t.EntityManager))],ve);let Se=class extends ye{constructor(t){super(),this.entityManager=t}onUpdate(){this.entityManager.search(Zt).forEach((({component:t,entity:e})=>{const i=this.entityManager.getComponent(e,Ft);if(i&&0!==i.data.length){0===t.shapes.length&&(t.composite?this.useEdges(t,i):this.useBoxes(t,i));for(const i of t.shapes)this.updatePositionAndVertices(i,t.offset,this.entityManager.getComponent(e,G)),this.updateBoundingBox(i),this.updateProjectionAxes(i)}}))}useBoxes(t,e){t.shapes=[],e.data.forEach(((i,s)=>{if(!this.needsCollider(i,s,e))return;const o=new p(this.generateRectangleVertices(s,e));o.updateCollisions=!1,t.shapes.push(o)}))}generateRectangleVertices(t,{width:e,height:i,tileWidth:s,tileHeight:o}){const r=-e*s/2+t%e*s,a=i*o/2-Math.floor(t/e)*o;return[new n(r,a-o),new n(r,a),new n(r+s,a),new n(r+s,a-o)]}needsCollider(t,e,{data:i,width:s,height:o}){return 0!==t&&this.getNeighbors(e,s,o).some((t=>!t||!i[t]||0===i[t]))}useEdges(t,e){t.shapes=[];const i=[],s=[];let o,r;e.data.forEach(((t,o)=>{if(0===t)return;const r=o%e.width,a=Math.floor(o/e.width);i[a]||(i[a]=[]),i[a+1]||(i[a+1]=[]),s[a]||(s[a]=[]),s[a+1]||(s[a+1]=[]);const n=this.getNeighbors(o,e.width,e.height);this.hasTile(n[0],e)||(i[a][r]=!0),this.hasTile(n[2],e)||(i[a+1][r]=!0),this.hasTile(n[1],e)||(s[a][r]=!0),this.hasTile(n[3],e)||(s[a][r+1]=!0)}));for(let s=0;s<i.length;s++)if(i[s])for(let a=0;a<i[s].length;a++)!o||!r||s===r.y&&i[s][a]||(t.shapes.push(this.createEdge(o,r,e)),o=void 0,r=void 0),i[s][a]&&(o||(o=new n(a,s)),r=new n(a+1,s));o&&r&&t.shapes.push(this.createEdge(o,r,e)),o=void 0,r=void 0;for(let i=0;i<=e.width;i++)for(let a=0;a<s.length;a++)s[a]&&(!o||!r||i===r.x&&s[a][i]||(t.shapes.push(this.createEdge(o,r,e)),o=void 0,r=void 0),s[a][i]&&(o||(o=new n(i,a)),r=new n(i,a+1)));o&&r&&t.shapes.push(this.createEdge(o,r,e))}hasTile(t,{data:e}){return void 0!==t&&e[t]&&e[t]>0}createEdge(t,e,{width:i,height:s,tileWidth:o,tileHeight:r}){t.x=-i*o/2+t.x*o,t.y=s*r/2-t.y*r,e.x=-i*o/2+e.x*o,e.y=s*r/2-e.y*r;const a=new p([new n(t.x,t.y),new n(e.x,e.y)]);return a.updateCollisions=!1,a}getNeighbors(t,e,i){return[t-e>=0?t-e:void 0,t%e>0?t-1:void 0,t+e<=e*i?t+e:void 0,t%e<e-1?t+1:void 0]}};Se=r([i(j.UpdateTilemapColliderShapeSystem),a(0,s(t.EntityManager))],Se);let Ce=class{constructor(t,e,i,s,o){this.entityManager=t,this.broadPhaseResolver=e,this.collisionMatrix=i,this.collisionResolutionMethod=s,this.collisionRepository=o,this.colliders=[],this.collisions=new Set,this.shapes=[]}onUpdate(){this.collisionRepository.removeAll(),this.colliders=[],this.collisions.clear(),this.shapes=[],[Kt,qt,Jt,Qt,Zt].forEach((t=>this.entityManager.search(t).forEach((({component:t,entity:e})=>{this.colliders.push(t),t.shapes.forEach((i=>{var s;i.entity=e,i.collider=this.colliders.length-1,i.id=this.shapes.length,i.ignoreCollisionsWithLayers=null!==(s=t.ignoreCollisionsWithLayers)&&void 0!==s?s:[],i.layer=t.layer,this.shapes.push(i)}))})))),this.broadPhaseResolver.update(this.shapes),this.shapes.filter((t=>t.updateCollisions)).forEach((t=>this.narrowPhase(t,this.broadPhase(t))))}broadPhase({boundingBox:t,layer:e}){return this.collisionMatrix?this.broadPhaseResolver.retrieve(t).map((t=>this.shapes[t])).filter((t=>this.collisionMatrix.some((i=>i[0]===e&&i[1]===t.layer||i[1]===e&&i[0]===t.layer)))):this.broadPhaseResolver.retrieve(t).map((t=>this.shapes[t]))}narrowPhase(t,e){e.filter((e=>t.entity!==e.entity&&t.id!==e.id&&!t.ignoreCollisionsWithLayers.includes(e.layer)&&!e.ignoreCollisionsWithLayers.includes(t.layer)&&!this.isResolved(t,e))).forEach((e=>{const i=this.collisionResolutionMethod.findCollision(t,e);i&&(this.collisionRepository.persist({localCollider:this.colliders[t.collider],localEntity:t.entity,remoteCollider:this.colliders[e.collider],remoteEntity:e.entity,resolution:i}),this.collisionRepository.persist({localCollider:this.colliders[e.collider],localEntity:e.entity,remoteCollider:this.colliders[t.collider],remoteEntity:t.entity,resolution:{direction:n.scale(new n,i.direction,-1),penetration:i.penetration}}),this.collisions.add(`${t.id}-${e.id}`),this.collisions.add(`${e.id}-${t.id}`))}))}isResolved(t,e){return this.collisions.has(`${t.id}-${e.id}`)}};Ce=r([i(j.ResolveCollisionSystem),a(0,s(t.EntityManager)),a(1,s(t.CollisionBroadphaseResolver)),a(2,s(t.CollisionMatrix)),a(3,s(t.CollisionResolutionMethod)),a(4,s(t.CollisionRepository))],Ce);let be=class{constructor(t,e,i){this.entityManager=t,this.collisionRepository=e,this.transformSystem=i,this.displacement=new n}onUpdate(){this.entityManager.search(ue,{type:ge.Dynamic}).forEach((({component:t,entity:e})=>{const i=this.entityManager.getComponent(e,G),s=[e,...i._childEntities];this.displacement.set(0,0),this.collisionRepository.findAll().filter((({localCollider:t,localEntity:e})=>s.includes(e)&&t.physics)).forEach((({resolution:{direction:t,penetration:e}})=>{e>this.displacement.magnitude&&n.scale(this.displacement,t,-e)})),0!==this.displacement.magnitude&&(n.add(i.position,i.position,this.displacement),this.displacement.x*t.velocity.x<0&&(t.velocity.x=0),this.displacement.y*t.velocity.y<0&&(t.velocity.y=0))})),this.transformSystem.onUpdate()}};be=r([i(j.ApplyRepositionSystem),a(0,s(t.EntityManager)),a(1,s(t.CollisionRepository)),a(2,s(j.TransformSystem))],be);let we=class extends ye{constructor(t){super(),this.entityManager=t}onUpdate(){[Kt,qt,Jt,Qt,Zt].forEach((t=>this.entityManager.search(t,{updateCollisions:!0}).forEach((({component:t,entity:e})=>t.shapes.forEach((i=>{this.updatePositionAndVertices(i,t.offset,this.entityManager.getComponent(e,G)),this.updateBoundingBox(i)}))))))}};we=r([i(j.UpdateCollidersAfterRepositionSystem),a(0,s(t.EntityManager))],we);const Ee=new Map([[V.PreGameLogic,[{name:j.KeyboardSystem,type:Gt},{name:j.MouseSystem,type:Wt},{name:j.TouchScreenSystem,type:Nt},{name:j.GamepadSystem,type:Vt},{name:j.ButtonSystem,type:At},{name:j.AudioPlayerSystem,type:O},{name:j.TiledWrapperSystem,type:Lt},{name:j.TilemapPreProcessingSystem,type:jt}]],[V.PostGameLogic,[{name:j.TransformSystem,type:Ot},{name:j.ChildrenSystem,type:Dt},{name:j.ParentSystem,type:Pt}]],[V.Physics,[{name:j.ApplyVelocitySystem,type:pe},{name:j.UpdateBallColliderShapeSystem,type:fe},{name:j.UpdateBoxColliderShapeSystem,type:xe},{name:j.UpdateEdgeColliderShapeSystem,type:Me},{name:j.UpdatePolygonColliderShapeSystem,type:ve},{name:j.UpdateTilemapColliderShapeSystem,type:Se},{name:j.ResolveCollisionSystem,type:Ce},{name:j.ApplyRepositionSystem,type:be},{name:j.UpdateCollidersAfterRepositionSystem,type:we}]],[V.Render,[{name:j.AnimatorSystem,type:Yt},{name:j.CameraSystem,type:Xt},{name:j.TilemapRendererSystem,type:de},{name:j.SpriteRendererSystem,type:he},{name:j.MaskRendererSystem,type:se},{name:j.ShadowLightRendererSystem,type:ne},{name:j.TextRendererSystem,type:ce},{name:j.VideoRendererSystem,type:bt},{name:j.ColliderRenderSystem,type:te},{name:j.CullingSystem,type:ee},{name:j.ClearScreenSystem,type:$t},{name:j.RenderSystem,type:oe}]]]);let _e=class{constructor(t,e,i){this.timeManager=t,this.systemManager=e,this.sceneManager=i,this.running=!1,this.gameLoopAccumulator=0}start(){this.running||(this.running=!0,this.gameLoopAccumulator=0,this.enableSystems(),this.sceneManager.loadOpeningScene(),this.requestAnimationLoop(window.performance.now()),this.asyncPhysicsLoop())}enableSystems(){Ee.forEach((t=>{t.forEach((t=>this.systemManager.enableSystem(t.type)))}))}stop(){this.running=!1}requestAnimationLoop(t){this.running&&(this.timeManager.updateForRender(.001*t),this.sceneManager.update(),this.gameLoopAccumulator+=this.timeManager.browserDeltaTime,this.gameLoopAccumulator>=this.timeManager.fixedGameDeltaTime&&(this.gameLogicIteration(.001*t),this.gameLoopAccumulator-=this.timeManager.fixedGameDeltaTime),this.renderIteration(),window.requestAnimationFrame((t=>this.requestAnimationLoop(t))))}gameLogicIteration(t){this.timeManager.updateForGame(t),this.systemManager.update(V.PreGameLogic),this.systemManager.update(V.GameLogic),this.systemManager.update(V.PostGameLogic)}renderIteration(){this.systemManager.update(V.GamePreRender),this.systemManager.update(V.Render)}asyncPhysicsLoop(){this.physicsIntervalId=window.setInterval((()=>{if(!this.running)return window.clearInterval(this.physicsIntervalId);this.timeManager.updateForPhysics(.001*window.performance.now()),document.hidden||this.physicsIteration()}),1e3/this.timeManager.fixedPhysicsFramerate)}physicsIteration(){this.timeManager.timeScale<=0||(this.systemManager.update(V.GamePhysics),this.systemManager.update(V.Physics))}};_e=r([i(t.LoopManager),a(0,s(t.TimeManager)),a(1,s(t.SystemManager)),a(2,s(t.SceneManager))],_e);class Re{constructor(t,e){this.container=t,this.systemManager=e,this.lastSystemTypeId=0}createSystemIfNotExists(t){if(this.systemManager.hasSystem(t))return;const e="__system_"+this.lastSystemTypeId++;var i;this.container.add(t,e),this.systemManager.addSystem(this.container.get(e),null!==(i=t.prototype.__system_group)&&void 0!==i?i:V.GameLogic)}}let Ae=class{constructor(t){this.webGLManager=t,this.renderData=[],this.cameraData=[]}addCameraData(t){this.cameraData.push(t)}addRenderData(t){this.renderData.push(t)}setRenderData(t){this.renderData=t}getCameraData(){return this.cameraData}getRenderData(){return this.renderData}removeCameraData(){this.cameraData=[]}removeRenderData(){this.renderData=[]}render(){this.cameraData.sort(((t,e)=>t.depth-e.depth)).forEach((t=>this.renderData.filter((e=>t.layers.includes(e.layer))).sort(((e,i)=>t.layers.indexOf(e.layer)-t.layers.indexOf(i.layer))).forEach((e=>this.webGLManager.render(e,t)))))}};Ae=r([i(t.RenderManager),a(0,s(t.WebGLManager))],Ae);class Te{constructor(i){this.container=(i=>{(t=>{var e,i,s,r,a,n,h,l;if(!(t.containerNode instanceof HTMLElement))throw new Error("GameConfig Error: Invalid containerNode");if("number"!=typeof t.width)throw new Error("GameConfig Error: Invalid width");if("number"!=typeof t.height)throw new Error("GameConfig Error: Invalid height");t.debugEnabled=null!==(e=t.debugEnabled)&&void 0!==e&&e,t.canvasColor=null!==(i=t.canvasColor)&&void 0!==i?i:"#000000",t.physicsFramerate=null!==(s=t.physicsFramerate)&&void 0!==s?s:180,t.headless=null!==(r=t.headless)&&void 0!==r&&r,t.collisions=null!==(a=t.collisions)&&void 0!==a?a:{},t.collisions.collisionBroadPhaseMethod=null!==(n=t.collisions.collisionBroadPhaseMethod)&&void 0!==n?n:o.SpartialGrid,t.collisions.collisionMatrix=null!==(h=t.collisions.collisionMatrix)&&void 0!==h?h:void 0,t.collisions.collisionMethod=null!==(l=t.collisions.collisionMethod)&&void 0!==l?l:x.SAT})(i);const s=new e;return s.set(t.GameConfig,i),s.set(t.CanvasElement,(({containerNode:t,width:e,height:i})=>{const s=document.createElement("canvas");return s.id="angryPixelGameCanvas",s.width=Math.floor(e),s.height=Math.floor(i),s.tabIndex=0,s.addEventListener("contextmenu",(t=>t.preventDefault())),t.appendChild(s),s.focus(),s})(i)),(e=>{const{collisions:{collisionBroadPhaseMethod:i,collisionMatrix:s,collisionMethod:r}}=e.get(t.GameConfig);e.add(w),e.add(C),r===x.AABB?(e.add(v),e.add(S)):e.add(b),e.add(i===o.QuadTree?m:u),e.add(r===x.AABB?f:M),e.set(t.CollisionMatrix,s)})(s),(e=>{e.add(E),e.add(_),e.set(t.SystemFactory,new Re(e,e.get(t.SystemManager))),e.add(U),e.add(L),e.add(B),e.add(Et),e.add(B),e.add(_e),e.add(vt),e.add(Ae)})(s),(e=>{e.get(t.GameConfig).headless&&(t=>{t.delete(V.Render),t.set(V.PreGameLogic,t.get(V.PreGameLogic).filter((({name:t})=>![j.AudioPlayerSystem,j.ButtonSystem,j.GamepadSystem,j.KeyboardSystem,j.MouseSystem,j.TouchScreenSystem].includes(t))))})(Ee),Ee.forEach(((i,s)=>i.forEach((({type:i,name:o})=>{e.add(i),e.get(t.SystemManager).addSystem(e.get(o),s)}))))})(s),s})(i)}get running(){return this.container.get(t.LoopManager).running}addScene(e,i,s=!1){this.container.get(t.SceneManager).addScene(e,i,s)}addDependencyType(t,e){this.container.add(t,e)}addDependencyInstance(t,e){this.container.set(e,t)}start(){this.container.get(t.LoopManager).start()}stop(){this.container.get(t.LoopManager).stop()}}class De{onUpdate(){}}r([s(t.EntityManager)],De.prototype,"entityManager",void 0),r([s(t.AssetManager)],De.prototype,"assetManager",void 0),r([s(t.SceneManager)],De.prototype,"sceneManager",void 0),r([s(t.TimeManager)],De.prototype,"timeManager",void 0),r([s(t.InputManager)],De.prototype,"inputManager",void 0),r([s(t.CollisionRepository)],De.prototype,"collisionRepository",void 0);class Be{constructor(){this.boundaries=[476,-476,896,-896],this.direction=new n(1,1),this.speed=200}}const Pe={logo:"image/logo.png"},Ue="Logo";class Fe extends De{onUpdate(){this.entityManager.search(Be).forEach((({component:t,entity:e})=>{const i=this.entityManager.getComponent(e,G),{boundaries:s,direction:o,speed:r}=t;(i.position.y>=s[0]||i.position.y<=s[1])&&(o.y*=-1),(i.position.x>=s[2]||i.position.x<=s[3])&&(o.x*=-1),i.position.x+=o.x*r*this.timeManager.deltaTime,i.position.y+=o.y*r*this.timeManager.deltaTime}))}}class Le extends wt{constructor(){super(...arguments),this.systems=[Fe]}loadAssets(){Object.values(Pe).forEach((t=>this.assetManager.loadImage(t)))}setup(){var t;this.entityManager.createEntity(((t,e=new n,i=0,s=1)=>[new G({position:e}),new N({layers:t,zoom:s,depth:i})])([Ue])),this.entityManager.createEntity((t=this.assetManager,[G,new Ht({layer:Ue,image:t.getImage(Pe.logo)}),Be]))}}const Ie=[],je=new URLSearchParams(window.location.search);(()=>{const t=new Te({containerNode:document.querySelector("#app"),width:1920,height:1080,canvasColor:"#00D9D9",collisions:{collisionMatrix:Ie},debugEnabled:Boolean(Number(je.get("debug")))});t.addScene(Le,"MainScene",!0),t.start()})()})();